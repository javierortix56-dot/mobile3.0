<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0F172A">
    <title>Finanzas J&M Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/96/wallet.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --bg: #F8FAFC; --surface: #FFFFFF; --txt: #1E293B; --txt-sec: #64748B; 
            --primary: #0F172A; --accent: #3B82F6; --inc: #10B981; --exp: #EF4444; 
            --border: #E2E8F0; --glass: rgba(255, 255, 255, 0.95);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; color: var(--txt); height: 100vh; overflow: hidden; user-select: none; display: flex; flex-direction: column; }

        /* HEADER */
        .header { 
            padding-top: calc(10px + var(--safe-top)); 
            padding-bottom: 10px;
            padding-left: 15px; padding-right: 15px;
            background: var(--glass); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 50; 
        }
        .brand { font-weight: 800; font-size: 13px; letter-spacing: -0.3px; display:flex; gap:6px; align-items:center; color: var(--primary); white-space: nowrap; }
        .sync-dot { width:8px; height:8px; border-radius:50%; background:#CBD5E1; transition:0.3s; box-shadow: 0 0 0 2px white; }
        .sync-spin { animation: spin 1s linear infinite; border: 2px solid #3B82F6; border-top: 2px solid transparent; background: transparent; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .date-pill { background: rgba(0,0,0,0.03); border-radius: 99px; padding: 4px 10px; display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .btn-arrow { background: none; border: none; font-size: 12px; color: var(--txt); cursor: pointer; padding: 4px; opacity: 0.6; }

        /* LAYOUT */
        .main-container { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .view-section { display: none; height: 100%; flex-direction: column; } 
        .view-section.active { display: flex; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD */
        .dash-content { padding: 8px 10px; display: flex; flex-direction: column; height: 100%; gap: 8px; }
        .kpi-hero { background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); padding: 12px; border-radius: 14px; color: white; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); flex-shrink: 0; }
        .hero-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .hero-bal { font-size: 24px; font-weight: 800; line-height: 1; transition: color 0.3s; }
        .hero-usd { font-size: 10px; opacity: 0.8; font-weight: 600; margin-left: 2px; transition: color 0.3s; }
        .tc-widget { background: rgba(255,255,255,0.1); padding: 1px 6px; border-radius: 4px; font-size: 9px; display: flex; align-items: center; gap: 3px; font-weight: 600; margin-bottom: 2px; }
        .tc-inp { background: transparent; border: none; color: white; font-weight: 700; width: 35px; text-align: right; font-size: 9px; border-bottom: 1px solid rgba(255,255,255,0.3); padding: 0; }
        .hero-stats { display: flex; gap: 10px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-item { flex: 1; display:flex; align-items: center; } 
        .stat-lbl { font-size: 8px; opacity: 0.6; font-weight: 600; }
        .stat-val { font-size: 11px; font-weight: 700; }

        /* TABS */
        .tabs-pill { display: flex; background: #E2E8F0; padding: 2px; border-radius: 8px; flex-shrink: 0; }
        .tab-btn { flex: 1; text-align: center; padding: 6px; border-radius: 6px; font-size: 10px; font-weight: 700; color: var(--txt-sec); cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        /* LISTAS */
        .grid-lists { display: flex; gap: 8px; flex: 1; min-height: 0; width: 100%; overflow: hidden; }
        .list-col { flex: 1; background: var(--surface); border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
        .col-head { padding: 6px; text-align: center; font-size: 9px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .bg-inc { background: var(--inc); justify-content: center; } 
        .bg-exp { background: var(--exp); }
        .list-scroll { flex: 1; overflow-y: auto; padding: 0; -webkit-overflow-scrolling: touch; }
        
        .search-container { display:flex; align-items:center; background:#FEF2F2; padding-right:5px; border-bottom:1px solid #fecaca; }
        .search-inp { width:100%; border:none; padding:6px; font-size:9px; background:transparent; }
        .btn-clear { background:none; border:none; font-size:10px; color:#EF4444; cursor:pointer; padding:0 5px; }

        /* TARJETA MOVIMIENTO */
        .tx-card { background: white; padding: 8px 10px; border-bottom: 1px solid #F1F5F9; cursor: pointer; }
        .tx-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .tx-desc { font-weight: 700; font-size: 11px; color: var(--txt); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; letter-spacing: -0.2px; }
        .tx-amt { font-weight: 800; font-size: 11px; }
        .tx-sub { display: flex; justify-content: space-between; font-size: 9px; color: var(--txt-sec); align-items: center; margin-top: 1px; }
        
        .cat-tag { background: #F1F5F9; padding: 0px 4px; border-radius: 3px; font-size: 8px; font-weight: 600; color: var(--txt-sec); }
        .source-tag { background: #DBEAFE; color: #1E40AF; padding: 0px 5px; border-radius: 3px; font-size: 9px; font-weight: 800; display: flex; align-items: center; gap: 3px; margin-right: 4px; }
        
        .acc-badge { font-size:8px; font-weight:700; padding:1px 4px; border-radius:4px; background:#f1f5f9; border:1px solid #e2e8f0; color:#64748b; margin-right:4px; }
        
        .magic-q { font-size: 9px; font-weight: 700; margin-left: 4px; }
        .q-ok { color: var(--inc); } .q-bad { color: var(--exp); }

        .executed { opacity: 0.5; }
        .executed .tx-desc, .executed .tx-amt { text-decoration: line-through; color: var(--txt-sec) !important; }

        /* NETWORTH / ACCOUNTS */
        .nw-card { background:white; border-radius:12px; padding:10px; border:1px solid var(--border); margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 1px 2px rgba(0,0,0,0.02); }
        .nw-icon { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; margin-right:10px; flex-shrink:0; }
        .nw-green { background:#D1FAE5; color:#059669; }
        .nw-red { background:#FEE2E2; color:#DC2626; }
        .nw-info { flex:1; min-width:0; }
        .nw-name { font-weight:700; font-size:11px; color:var(--txt); }
        .nw-curr { font-size:9px; color:var(--txt-sec); font-weight:600; }
        .nw-val { text-align:right; }
        .nw-amt { font-weight:800; font-size:11px; color:var(--txt); }
        .nw-native { font-size:9px; color:var(--txt-sec); }

        /* ALLOCATION */
        .alloc-container { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .alloc-card { background: white; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 8px; overflow: hidden; }
        .alloc-head { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .alloc-prog { height: 4px; width: 100%; background: #E2E8F0; }
        .alloc-fill { height: 100%; background: var(--inc); }
        .alloc-children { background: #F8FAFC; display: none; border-top: 1px solid var(--border); }
        .child-row { padding: 8px 10px; display: flex; justify-content: space-between; font-size: 11px; color: var(--txt); border-bottom: 1px solid rgba(0,0,0,0.03); cursor: pointer; } 
        .child-row:active { background: #F1F5F9; }
        .child-row.executed span { text-decoration: line-through; opacity: 0.6; }
        
        .alloc-tools { display: flex; gap:8px; margin-bottom:10px; }
        .btn-alloc { flex:1; padding:10px; border-radius:8px; font-size:10px; font-weight:700; border:none; display:flex; align-items:center; justify-content:center; gap:6px; cursor:pointer; }
        .btn-auto { background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3); }
        .btn-reset { background: white; border: 1px solid var(--border); color: #EF4444; }

        /* CHARTS */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
        .chart-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; }
        .chart-header { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--txt-sec); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .chart-body { display: flex; align-items: center; gap: 10px; height: 160px; }
        .chart-line-body { height: 160px; width: 100%; position: relative; }
        .donut-container { width: 120px; height: 120px; flex-shrink: 0; position: relative; }
        .legend-container { flex: 1; height: 100%; overflow-y: auto; padding-right: 2px; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; font-size: 9px; padding: 5px 0; border-bottom: 1px dashed #F1F5F9; cursor: pointer; }
        .legend-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 5px; flex-shrink: 0; }
        .legend-name { color: var(--txt); font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* NAV & SHEET */
        .bottom-nav { height: 60px; background: var(--glass); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; padding-bottom: var(--safe-bottom); }
        .nav-btn { font-size: 18px; color: #CBD5E1; background: none; border: none; padding: 6px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn span { font-size: 9px; font-weight: 700; }
        .nav-btn.active { color: var(--primary); }
        .fab { width: 48px; height: 48px; background: var(--primary); border-radius: 16px; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; transform: translateY(-15px); border: 4px solid var(--bg); box-shadow: 0 6px 15px rgba(15,23,42,0.3); }

        .sheet, .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: 0.2s; display: flex; align-items: flex-end; backdrop-filter: blur(2px); }
        .sheet.open, .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .sheet-box { background: var(--surface); width: 100%; border-radius: 16px 16px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding-bottom: calc(20px + var(--safe-bottom)); }
        .sheet.open .sheet-box { transform: translateY(0); }
        .modal-center { background: white; width: 85%; margin: auto; border-radius: 16px; padding: 20px; transform: scale(0.9); transition: 0.2s; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-overlay.open .modal-center { transform: scale(1); }

        /* FORM */
        .big-inp { width: 100%; border: none; background: #F1F5F9; border-radius: 10px; font-size: 20px; font-weight: 800; padding: 12px; color: var(--txt); text-align: right; margin-bottom: 8px; }
        .chip-container { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 12px; scrollbar-width: none; }
        .chip { padding: 5px 10px; border-radius: 6px; background: white; border: 1px solid var(--border); color: var(--txt-sec); font-weight: 600; font-size: 10px; white-space: nowrap; transition: 0.1s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .inp-lbl { font-size: 9px; font-weight: 800; color: var(--txt-sec); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .sel-acc { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:white; font-size:11px; font-weight:700; margin-bottom:10px; }
        
        /* IOS SWITCH */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; -webkit-transition: .4s; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; -webkit-transition: .4s; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--inc); }
        input:checked + .slider:before { -webkit-transform: translateX(14px); -ms-transform: translateX(14px); transform: translateX(14px); }

        /* SETTINGS & TREE */
        .settings-group { margin-bottom: 20px; }
        .tree-node { margin-bottom: 6px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: white; }
        .tree-head { padding: 6px 10px; background: #F8FAFC; display: flex; justify-content: space-between; align-items: center; font-size: 10px; font-weight: 700; cursor: pointer; }
        .tree-body { padding: 6px; display: none; flex-wrap: wrap; gap: 4px; border-top: 1px solid var(--border); }
        .concept-tag { font-size: 9px; padding: 2px 6px; background: #F1F5F9; border-radius: 4px; border: 1px solid transparent; display: flex; align-items: center; gap: 3px; }

        .loader { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:200; display:none; align-items:center; justify-content:center; }
        
        .lock-badge { font-size:10px; color:#EF4444; margin-right:5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity:0.5; } 50% { opacity:1; } 100% { opacity:0.5; } }
    </style>
</head>
<body>

<div id="loader" class="loader"><i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary)"></i></div>

<div class="header">
    <div class="brand">
        <i class="fas fa-lock lock-badge" id="lockIcon" style="display:none;"></i>
        Finanzas J&M Pro 
        <div id="syncDot" class="sync-dot"></div>
    </div>
    <div class="date-pill" onclick="changeMonth(0)"> 
        <button class="btn-arrow" onclick="event.stopPropagation(); changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="date-txt" id="monthTxt">...</div>
        <button class="btn-arrow" onclick="event.stopPropagation(); changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div style="width:20px;"></div>
</div>

<div class="main-container">

    <div id="view-home" class="view-section active">
        <div class="dash-content">
            <div class="kpi-hero">
                <div class="hero-top">
                    <div>
                        <div class="hero-bal" id="kpiBal">$0</div>
                        <div class="hero-usd">≈ USD <span id="kpiUsd">0</span></div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <div class="tc-widget">1 USD = <input type="number" inputmode="decimal" id="rateArs" value="1200" class="tc-inp" onchange="saveRates()"> ARS</div>
                        <div class="tc-widget">1 USD = <input type="number" inputmode="decimal" id="rateCop" value="3700" class="tc-inp" onchange="saveRates()"> COP</div>
                    </div>
                </div>
                <div class="hero-stats">
                    <div class="stat-item" style="justify-content:flex-start; gap:8px;"><span class="stat-lbl">INGRESOS</span><span class="stat-val" style="color:#34D399" id="sum-inc">$0</span></div>
                    <div class="stat-item" style="justify-content:flex-end; gap:8px;"><span class="stat-lbl">GASTOS</span><span class="stat-val" style="color:#F87171" id="sum-exp">$0</span></div>
                </div>
            </div>

            <div class="tabs-pill">
                <div class="tab-btn active" id="tab-txs" onclick="setSubTab('txs')">Movimientos</div>
                <div class="tab-btn" id="tab-alloc" onclick="setSubTab('alloc')">Asignación</div>
            </div>

            <div id="sec-txs" class="grid-lists">
                <div class="list-col">
                    <div class="col-head bg-inc">Ingresos</div>
                    <div id="list-inc" class="list-scroll"></div>
                </div>
                <div class="list-col">
                    <div class="col-head bg-exp">
                        <span>Egresos</span>
                        <i class="fas fa-search" style="opacity:0.7; font-size:9px;" onclick="document.getElementById('searchBar').classList.toggle('hidden')"></i>
                    </div>
                    <div id="searchContainerExp" class="search-container hidden">
                        <input type="text" id="searchBar" placeholder="Buscar..." class="search-inp" oninput="filterExp()">
                        <button class="btn-clear" onclick="clearSearch('exp')"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="list-exp" class="list-scroll"></div>
                </div>
            </div>

            <div id="sec-alloc" style="display:none;" class="alloc-container">
                <div class="alloc-tools">
                    <button class="btn-alloc btn-auto" onclick="autoAssign()"><i class="fas fa-magic"></i> Auto-Asignar</button>
                    <button class="btn-alloc btn-reset" onclick="unassignAll()"><i class="fas fa-unlink"></i> Desasignar Todo</button>
                </div>
                <div class="search-alloc-wrap" style="display:flex; align-items:center; background:#F1F5F9; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; padding-right:8px;">
                    <input type="text" id="allocSearch" style="width:100%; padding:8px; border:none; background:transparent; font-size:11px;" placeholder="Buscar gasto asignado..." oninput="renderAlloc()">
                    <button class="btn-clear" onclick="clearSearch('alloc')"><i class="fas fa-times"></i></button>
                </div>
                <div id="alloc-list"></div>
            </div>
        </div>
    </div>

    <div id="view-networth" class="view-section" style="padding:10px; overflow-y:auto; background:#F1F5F9;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; font-size:14px; font-weight:800; color:var(--primary);">Patrimonio</h3>
            <button onclick="openAccountSheet()" style="background:var(--primary); color:white; border:none; border-radius:6px; padding:6px 10px; font-size:10px; font-weight:700;">+ Cuenta</button>
        </div>
        
        <div class="chart-card" style="margin-bottom:15px; height:200px;">
            <div class="chart-header"><span>Evolución (USD)</span></div>
            <div class="chart-line-body" style="height:100%;">
                <canvas id="chartNetWorth"></canvas>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
             <div class="nw-card" style="flex-direction:column; align-items:flex-start; margin:0;">
                 <span style="font-size:9px; font-weight:700; color:var(--txt-sec); text-transform:uppercase;">Activos</span>
                 <span style="font-size:16px; font-weight:800; color:#059669;" id="nw-assets">$0</span>
             </div>
             <div class="nw-card" style="flex-direction:column; align-items:flex-start; margin:0;">
                 <span style="font-size:9px; font-weight:700; color:var(--txt-sec); text-transform:uppercase;">Pasivos</span>
                 <span style="font-size:16px; font-weight:800; color:#DC2626;" id="nw-liabs">$0</span>
             </div>
        </div>

        <div id="list-accounts"></div>
    </div>

    <div id="view-stats" class="view-section" style="padding:10px; overflow-y:auto;">
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <span id="titleExp">Gastos por Categoría</span>
                    <button onclick="resetChart('exp')" id="resetExp" style="border:none; background:none; color:var(--accent); font-size:9px; display:none;">VOLVER</button>
                </div>
                <div class="chart-body">
                    <div class="donut-container"><canvas id="chartExp"></canvas></div>
                    <div class="legend-container" id="legExp"></div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span id="titleInc">Ingresos por Categoría</span>
                    <button onclick="resetChart('inc')" id="resetInc" style="border:none; background:none; color:var(--accent); font-size:9px; display:none;">VOLVER</button>
                </div>
                <div class="chart-body">
                    <div class="donut-container"><canvas id="chartInc"></canvas></div>
                    <div class="legend-container" id="legInc"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-settings" class="view-section" style="padding:15px; overflow-y:auto;">
        <div class="settings-group">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span class="inp-lbl">Gastos Recurrentes</span>
                <span style="color:var(--accent); font-size:10px; font-weight:700; cursor:pointer;" onclick="addRecurrenteUI()">+ Agregar</span>
            </div>
            <div id="list-recurrentes"></div>
            <button onclick="populateRecurringDefaults()" style="width:100%; padding:8px; background:white; border:1px solid var(--border); border-radius:8px; font-size:9px; font-weight:700; color:var(--txt-sec); margin-top:5px;">Analizar Historial (3M)</button>
        </div>
        
        <div class="settings-group">
            <div class="inp-lbl">Categorías</div>
            <div id="admin-tree"></div>
        </div>

        <div class="settings-group">
            <div class="inp-lbl">Herramientas</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <button onclick="executeRecurrentes()" style="padding:10px; background:white; border:1px solid var(--border); border-radius:8px; font-size:9px; font-weight:700;">Ejecutar Recurrentes</button>
                <button onclick="openCloneModal()" style="padding:10px; background:white; border:1px solid var(--border); border-radius:8px; font-size:9px; font-weight:700;">Clonar Mes...</button>
                <button onclick="forceSync()" style="grid-column:span 2; padding:10px; background:white; border:1px solid var(--border); border-radius:8px; font-size:10px; font-weight:700; color:var(--primary);">Sincronizar Nube (Forzado)</button>
                <button id="btnCloseMonth" onclick="toggleMonthClose()" style="grid-column:span 2; padding:10px; background:#1E293B; border-radius:8px; font-size:9px; font-weight:700; color:white;">Cerrar Mes</button>
                <button onclick="clearMonth()" style="grid-column:span 2; padding:10px; background:#FEF2F2; border:1px solid #FECACA; border-radius:8px; font-size:9px; font-weight:700; color:#EF4444;">Borrar Todo el Mes</button>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" id="nav-home" onclick="nav('home')"><i class="fas fa-wallet"></i><span>Home</span></button>
    <button class="nav-btn" id="nav-networth" onclick="nav('networth')"><i class="fas fa-landmark"></i><span>Patrim.</span></button>
    <div class="fab" onclick="openNewTx()"><i class="fas fa-plus"></i></div>
    <button class="nav-btn" id="nav-stats" onclick="nav('stats')"><i class="fas fa-chart-pie"></i><span>Stats</span></button>
    <button class="nav-btn" id="nav-settings" onclick="nav('settings')"><i class="fas fa-cog"></i><span>Ajustes</span></button>
</div>

<div class="sheet" id="sheet" onclick="if(event.target===this) closeSheet()">
    <div class="sheet-box">
        <form id="txForm">
            <div style="display:flex; gap:10px;">
                <input type="number" inputmode="decimal" id="fAmount" class="big-inp" placeholder="0" step="0.01" required>
                <select id="fCurr" style="width:70px; margin-bottom:8px; background:#E2E8F0; border:none; border-radius:10px; font-weight:700; text-align:center; font-size:12px;">
                    <option value="ARS">ARS</option>
                    <option value="USD">USD</option>
                    <option value="COP">COP</option>
                </select>
            </div>
            <div class="tabs-pill" style="margin-bottom:12px;">
                <div class="tab-btn active" id="seg-exp" onclick="setType('exp')">Gasto</div>
                <div class="tab-btn" id="seg-inc" onclick="setType('inc')">Ingreso</div>
                <div class="tab-btn" id="seg-trf" onclick="setType('transfer')">Transf.</div>
            </div>
            <input type="hidden" id="fType" value="exp">
            
            <div id="splitWarning" style="display:none; background:#EEF2FF; border:1px dashed #6366F1; padding:8px; border-radius:8px; margin-bottom:10px; font-size:10px; color:#312E81;">
                <i class="fas fa-info-circle"></i> <b>Es un Split (Dividido)</b><br>
                Los items se preservarán. Solo puedes editar fecha, ejecutado y totales aquí.
                <div id="splitList" style="margin-top:5px; padding-left:10px; font-size:9px; opacity:0.8;"></div>
            </div>

            <div id="acc-selectors" style="display:flex; gap:10px; margin-bottom:10px;">
                 <div style="flex:1; display:none;" id="div-from">
                     <span class="inp-lbl">ORIGEN</span>
                     <select id="fFromAcc" class="sel-acc"></select>
                 </div>
                 <div style="flex:1; display:none;" id="div-to">
                     <span class="inp-lbl">DESTINO</span>
                     <select id="fToAcc" class="sel-acc"></select>
                 </div>
            </div>

            <div id="div-cat" style="margin-bottom:12px;">
                <span class="inp-lbl">CATEGORÍA</span>
                <div class="chip-container" id="catChips"></div>
                <input type="hidden" id="fCat">
            </div>

            <div id="div-desc" style="margin-bottom:12px;">
                <span class="inp-lbl">CONCEPTO</span>
                <div class="chip-container" id="conChips"></div>
                <input type="text" id="fCustomDesc" class="big-inp" style="font-size:14px; text-align:left; display:none; background:white; border:1px solid var(--border);" placeholder="Nombre...">
                <input type="hidden" id="fConcept">
            </div>

            <div id="linkSection" style="margin-bottom:12px;">
                <span class="inp-lbl" style="color:var(--accent);">VINCULAR A INGRESO</span>
                <div class="chip-container" id="linkChips"></div>
                <input type="hidden" id="fLink">
            </div>

            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:flex-end;">
                <div style="flex-grow:1;">
                    <span class="inp-lbl">FECHA</span>
                    <input type="date" id="fDate" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:#F8FAFC; font-size:12px;" required>
                </div>
                <div style="flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end;">
                     <span class="inp-lbl">EJECUTADO</span>
                     <div style="height:37px; display:flex; align-items:center;">
                        <label class="switch">
                          <input type="checkbox" id="fExec">
                          <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="submit" style="width:100%; padding:14px; background:var(--primary); color:white; font-weight:800; border-radius:10px; border:none; margin-bottom:8px;">GUARDAR</button>
            <button type="button" id="btnDel" onclick="delTx()" style="width:100%; color:#EF4444; background:none; border:none; font-weight:700; font-size:12px; display:none;">Eliminar</button>
        </form>
    </div>
</div>

<div class="sheet" id="sheetAcc" onclick="if(event.target===this) closeAccSheet()">
    <div class="sheet-box">
        <h3 style="margin-top:0; margin-bottom:15px; font-size:16px;">Cuenta / Activo</h3>
        <form id="accForm" onsubmit="saveAccount(event)">
            <input type="text" id="accName" class="big-inp" style="text-align:left; font-size:16px;" placeholder="Nombre (ej: Banco Galicia)" required>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1;">
                    <span class="inp-lbl">TIPO</span>
                    <select id="accType" class="sel-acc" style="margin:0;"></select>
                </div>
                <div style="flex:1;">
                     <span class="inp-lbl">CLASE</span>
                     <select id="accKind" class="sel-acc" style="margin:0;">
                          <option value="asset">Activo</option>
                          <option value="liability">Pasivo (Deuda)</option>
                     </select>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <div style="flex:1;">
                    <span class="inp-lbl">MONEDA</span>
                    <select id="accCurr" class="sel-acc" style="margin:0;">
                         <option value="ARS">ARS</option>
                         <option value="USD">USD</option>
                         <option value="COP">COP</option>
                    </select>
                </div>
                <div style="flex:1;">
                     <span class="inp-lbl">SALDO INICIAL</span>
                     <input type="number" inputmode="decimal" id="accInit" class="sel-acc" style="margin:0;" placeholder="0" step="0.01">
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <span class="inp-lbl">FECHA DE ALTA (CREACIÓN)</span>
                <input type="date" id="accDate" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:#F8FAFC; font-size:12px;" required>
            </div>
            <button type="submit" style="width:100%; padding:14px; background:var(--primary); color:white; font-weight:800; border-radius:10px; border:none; margin-bottom:8px;">GUARDAR CUENTA</button>
            <button type="button" id="btnDelAcc" onclick="delAccount()" style="width:100%; color:#EF4444; background:none; border:none; font-weight:700; font-size:12px; display:none;">Eliminar</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="modalClone">
    <div class="modal-center">
        <h3 style="margin-top:0; margin-bottom:10px;">Clonar Mes</h3>
        <p style="font-size:11px; color:#666; margin-bottom:15px;">Selecciona el mes origen para copiar sus movimientos.</p>
        <select id="selCloneSrc" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:8px;"></select>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('modalClone').classList.remove('open')" style="flex:1; padding:10px; border:none; background:#eee; border-radius:8px; font-weight:700;">Cancelar</button>
            <button onclick="doCloneMonth()" style="flex:1; padding:10px; border:none; background:var(--primary); color:white; border-radius:8px; font-weight:700;">Clonar</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    const MONTHS = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];
    const PALETTE = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#64748B','#EC4899','#14B8A6'];

    let data = { 
        txs: [], 
        accounts: [],
        accountCats: ['Efectivo', 'Banco', 'Inversiones', 'Cripto', 'Tarjeta', 'Otro'],
        cats: { exp:['Esenciales','Varios'], inc:['Sueldo'] }, 
        concepts: {}, 
        recurrentes: [], 
        monthlyRates: {},
        closedMonths: {} 
    };
    
    let currentTxs = [], editId = null, editAccId = null;
    let drillCatExp = null, drillCatInc = null;
    let tempCat='', tempLink='';
    let currentDate = new Date(); currentDate.setDate(1);
    let saveTimer = null;

    let editingSplitChildren = null; 

    const fmt = (n) => n.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    const fmtUsd = (n) => (n/1000).toFixed(1) + 'K';

    window.onload = () => { 
        loadLocal(); 
        updateDateUI(); 
        forceSync(); 
    };

    function updateDateUI() { 
        document.getElementById('monthTxt').innerText = `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; 
        refreshAll(); 
    }
    function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); updateDateUI(); }
    
    function saveRates() {
        const key = getKey();
        if(!data.monthlyRates) data.monthlyRates={};
        data.monthlyRates[key] = { ARS: parseFloat(document.getElementById('rateArs').value)||1200, COP: parseFloat(document.getElementById('rateCop').value)||3700 };
        saveData();
    }
    function getKey() { return `${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
    function isMonthClosed() { return !!data.closedMonths[getKey()]; }

    // --- CORE DATA LOGIC ---
    function loadLocal() {
        const stored = localStorage.getItem('finance_mobile_data_v17'); 
        if(stored) data = JSON.parse(stored);
        if(!data.accounts) data.accounts = [];
        if(!data.txs) data.txs = [];
        if(!data.closedMonths) data.closedMonths = {};
        if(!data.accountCats) data.accountCats = ['Efectivo', 'Banco', 'Inversiones', 'Cripto', 'Tarjeta', 'Otro'];
    }

    function refreshAll() {
        const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
        const key = getKey();
        let rates = (data.monthlyRates && data.monthlyRates[key]) ? data.monthlyRates[key] : { ARS: 1200, COP: 3700 };
        document.getElementById('rateArs').value = rates.ARS; 
        document.getElementById('rateCop').value = rates.COP;

        // CHECK MONTH CLOSED UI
        const closed = isMonthClosed();
        document.getElementById('lockIcon').style.display = closed ? 'inline-block' : 'none';
        document.getElementById('btnCloseMonth').innerText = closed ? 'Reabrir Mes' : 'Cerrar Mes';
        document.getElementById('btnCloseMonth').style.background = closed ? '#FFFFFF' : '#1E293B';
        document.getElementById('btnCloseMonth').style.color = closed ? '#0F172A' : '#FFFFFF';
        document.getElementById('btnCloseMonth').style.border = closed ? '1px solid #CBD5E1' : 'none';

        currentTxs = (data.txs || []).filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
        currentTxs.forEach(t => {
            if(!t.exec && t.curr && t.curr!=='ARS') {
                if(t.curr === 'USD') t.amount = t.origAmt * rates.ARS;
                else if(t.curr === 'COP') t.amount = (t.origAmt / rates.COP) * rates.ARS; 
            }
        });
        currentTxs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
        
        renderDash(); 
        renderAlloc();
        if(document.getElementById('view-stats').classList.contains('active')) renderStats();
        if(document.getElementById('view-settings').classList.contains('active')) renderSettings();
        if(document.getElementById('view-networth').classList.contains('active')) renderNetWorth();
    }

    function renderDash() {
        const inc = currentTxs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
        const exp = currentTxs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
        const bal = inc - exp;
        const rateArs = parseFloat(document.getElementById('rateArs').value)||1;
        
        const balEl = document.getElementById('kpiBal');
        const color = bal >= 0 ? '#34D399' : '#F87171';
        
        balEl.innerText = `AR$ ${fmt(bal)}`;
        balEl.style.color = color;
        document.getElementById('kpiUsd').innerText = fmt(Math.round(bal/rateArs));
        document.getElementById('kpiUsd').style.color = color;
        
        document.getElementById('sum-inc').innerText = `$${fmt(inc)}`;
        document.getElementById('sum-exp').innerText = `$${fmt(exp)}`;

        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';

        let runningBal = 0;
        const balMap = {};
        currentTxs.forEach(t => {
            if(t.type === 'inc') runningBal += t.amount;
            else if(t.type === 'exp') runningBal -= t.amount;
            balMap[t.id] = runningBal;
        });

        currentTxs.forEach(t => {
            if(t.type === 'transfer') return;

            const isInc = t.type === 'inc';
            const el = document.createElement('div');
            el.className = `tx-card ${t.exec ? 'executed' : ''}`;
            el.onclick = () => edit(t.id);
            
            let extraInfo = (t.curr && t.curr!=='ARS') ? `<span style="color:var(--accent); font-weight:800; margin-left:4px;">${t.origAmt} ${t.curr}</span>` : '';
            let sourceTag = '';
            
            if(!isInc && t.linkId) {
                const parentInc = currentTxs.find(x => x.id == t.linkId);
                if(parentInc) sourceTag = `<span class="source-tag"><i class="fas fa-link" style="font-size:8px;"></i> ${parentInc.desc}</span>`;
            }

            let qMagic = '';
            if(!isInc) {
                const currentGlobalBal = balMap[t.id];
                qMagic = `<span class="magic-q ${currentGlobalBal>=0?'q-ok':'q-bad'}">Sub: $${fmt(currentGlobalBal)}</span>`;
            }

            let splitBadge = (t.children && t.children.length) ? `<span class="cat-tag" style="background:#e0e7ff; color:#4338ca;">DIVIDIDO</span>` : '';
            let accName = '';
            if(t.fromAccountId) { const a = data.accounts.find(x=>x.id==t.fromAccountId); if(a) accName = a.name; }
            else if(t.toAccountId) { const a = data.accounts.find(x=>x.id==t.toAccountId); if(a) accName = a.name; }
            let accBadge = accName ? `<span class="acc-badge">${accName}</span>` : '';

            const catDisplay = isInc ? `<span class="cat-tag">${t.cat}</span>` : '';

            el.innerHTML = `
                <div class="tx-top">
                    <div class="tx-desc">${t.desc || (t.children?'(Varios)':'')}</div>
                    <div class="tx-amt" style="color:${isInc?'var(--inc)':'var(--txt)'}">$${fmt(t.amount)}</div>
                </div>
                <div class="tx-sub">
                    <div style="display:flex; align-items:center;">
                        ${sourceTag} ${accBadge}
                        ${catDisplay} ${splitBadge} ${extraInfo}
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        ${qMagic}
                        <span style="margin-left:5px;">${t.date.split('-')[2]}</span>
                        <i class="fas fa-copy" style="color:#cbd5e1; font-size:10px;" onclick="event.stopPropagation(); cloneTx('${t.id}')"></i>
                    </div>
                </div>
            `;
            (isInc ? lInc : lExp).appendChild(el);
        });
        filterExp();
    }

    // --- NET WORTH LOGIC ---
    function renderNetWorth() {
        const rates = { ARS: parseFloat(document.getElementById('rateArs').value)||1200, COP: parseFloat(document.getElementById('rateCop').value)||3700 };
        // Filtrar por fecha de corte (fin de mes actual)
        const currentEnd = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).toISOString().split('T')[0];
        const balances = computeBalancesAsOf(currentEnd, rates);
        
        const list = document.getElementById('list-accounts');
        list.innerHTML = '';
        
        let totalAssets = 0, totalLiabs = 0;

        // Mostrar cuentas activas a la fecha actual
        data.accounts.forEach(a => {
            // Si la cuenta se crea DESPUES del periodo actual, no la mostramos (o saldo 0)
            if(a.dateCreated && a.dateCreated > currentEnd) return;

            const bal = balances[a.id] || 0;
            const balARS = (a.currency==='ARS') ? bal : (a.currency==='USD' ? bal * rates.ARS : (bal / rates.COP) * rates.ARS);
            
            if(a.kind === 'asset') totalAssets += balARS; else totalLiabs += balARS;

            const icon = a.kind === 'asset' ? 'fa-arrow-up' : 'fa-arrow-down';
            const colorClass = a.kind === 'asset' ? 'nw-green' : 'nw-red';
            
            const el = document.createElement('div');
            el.className = 'nw-card';
            el.onclick = () => editAccount(a.id);
            el.innerHTML = `
                <div style="display:flex; align-items:center; flex:1;">
                    <div class="nw-icon ${colorClass}"><i class="fas ${icon}"></i></div>
                    <div class="nw-info">
                        <div class="nw-name">${a.name}</div>
                        <div class="nw-curr">${a.type.toUpperCase()} • ${a.currency}</div>
                    </div>
                </div>
                <div class="nw-val">
                    <div class="nw-amt">${a.currency} ${fmt(bal)}</div>
                    ${a.currency!=='ARS' ? `<div class="nw-native">≈ $${fmt(balARS)}</div>` : ''}
                </div>
            `;
            list.appendChild(el);
        });

        document.getElementById('nw-assets').innerText = `$${fmt(totalAssets)}`;
        document.getElementById('nw-liabs').innerText = `$${fmt(totalLiabs)}`;

        renderNetWorthChart(rates);
    }

    function computeBalancesAsOf(isoEnd, rates) {
        const bal = {};
        data.accounts.forEach(a => { 
            // Si la cuenta no existía en esa fecha, saldo 0
            if(a.dateCreated && a.dateCreated > isoEnd) {
                bal[a.id] = 0;
            } else {
                bal[a.id] = parseFloat(a.initBal)||0; 
            }
        });
        
        data.txs.filter(t => !t.deletedAt && t.date <= isoEnd).forEach(t => {
            const getAmtForAcc = (accId) => {
                const acc = data.accounts.find(a=>a.id===accId);
                if(!acc) return 0;
                // Si la cuenta no existía en fecha de la transaccion (caso raro pero posible por error)
                if(acc.dateCreated && acc.dateCreated > t.date) return 0;

                let txValInARS = t.amount; 
                if(t.curr === 'USD') txValInARS = t.origAmt * rates.ARS;
                else if(t.curr === 'COP') txValInARS = (t.origAmt / rates.COP) * rates.ARS;

                if(acc.currency === 'ARS') return txValInARS;
                if(acc.currency === 'USD') return txValInARS / rates.ARS;
                if(acc.currency === 'COP') return (txValInARS / rates.ARS) * rates.COP;
                return 0;
            };

            if(t.type === 'inc' && t.toAccountId) bal[t.toAccountId] += getAmtForAcc(t.toAccountId);
            if(t.type === 'exp' && t.fromAccountId) bal[t.fromAccountId] -= getAmtForAcc(t.fromAccountId);
            if(t.type === 'transfer' && t.fromAccountId && t.toAccountId) {
                bal[t.fromAccountId] -= getAmtForAcc(t.fromAccountId);
                bal[t.toAccountId] += getAmtForAcc(t.toAccountId); 
            }
        });
        return bal;
    }

    function renderNetWorthChart(rates) {
        const cvs = document.getElementById('chartNetWorth');
        const chartInstance = Chart.getChart(cvs);
        if(chartInstance) chartInstance.destroy();
        
        const labels = [], dataPoints = [];
        let d = new Date(); d.setDate(1); d.setMonth(d.getMonth()-6); 
        
        for(let i=0; i<7; i++) {
            const end = new Date(d.getFullYear(), d.getMonth()+1, 0).toISOString().split('T')[0];
            const bals = computeBalancesAsOf(end, rates);
            let net = 0;
            data.accounts.forEach(a => {
                let v = bals[a.id];
                // Normalizar todo a USD para la grafica histórica (estándar internacional)
                let vUSD = (a.currency==='USD') ? v : (a.currency==='ARS' ? v/rates.ARS : v/rates.COP);
                if(a.kind==='liability') net -= vUSD; else net += vUSD;
            });
            labels.push(MONTHS[d.getMonth()]);
            dataPoints.push(net);
            d.setMonth(d.getMonth()+1);
        }

        new Chart(cvs, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Patrimonio (USD)',
                    data: dataPoints,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2, fill: true, tension: 0.3
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display:false } }, y: { ticks: { callback: v => parseInt(v/1000)+'k' } } }
            }
        });
    }

    // --- ACCOUNT MANAGEMENT ---
    function openAccountSheet() { 
        if(isMonthClosed()) return alert("Mes Cerrado");
        editAccId=null; document.getElementById('accForm').reset(); document.getElementById('btnDelAcc').style.display='none'; 
        
        // Render Account Types from Config
        const sel = document.getElementById('accType'); sel.innerHTML='';
        data.accountCats.forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
        
        document.getElementById('accDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('sheetAcc').classList.add('open'); 
    }
    function closeAccSheet() { document.getElementById('sheetAcc').classList.remove('open'); }
    
    function saveAccount(e) {
        e.preventDefault();
        const acc = {
            id: editAccId || 'acc_'+Date.now(),
            name: document.getElementById('accName').value,
            type: document.getElementById('accType').value,
            kind: document.getElementById('accKind').value,
            currency: document.getElementById('accCurr').value,
            initBal: parseFloat(document.getElementById('accInit').value)||0,
            dateCreated: document.getElementById('accDate').value // GUuardar fecha creacion
        };
        if(editAccId) { const i=data.accounts.findIndex(x=>x.id==editAccId); data.accounts[i]=acc; }
        else data.accounts.push(acc);
        saveData(); closeAccSheet(); refreshAll();
    }
    function editAccount(id) {
        if(isMonthClosed()) return alert("Mes Cerrado");
        const a = data.accounts.find(x=>x.id===id); if(!a) return;
        editAccId = id;
        
        // Render types
        const sel = document.getElementById('accType'); sel.innerHTML='';
        data.accountCats.forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });
        
        document.getElementById('accName').value = a.name;
        document.getElementById('accType').value = a.type;
        document.getElementById('accKind').value = a.kind;
        document.getElementById('accCurr').value = a.currency;
        document.getElementById('accInit').value = a.initBal;
        document.getElementById('accDate').value = a.dateCreated || new Date().toISOString().split('T')[0];

        document.getElementById('btnDelAcc').style.display='block';
        document.getElementById('sheetAcc').classList.add('open');
    }
    function delAccount() { if(confirm('Borrar cuenta?')) { data.accounts = data.accounts.filter(x=>x.id!==editAccId); saveData(); closeAccSheet(); refreshAll(); } }

    // --- TRANSACTION FORM LOGIC ---
    function openNewTx() { 
        if(isMonthClosed()) return alert("Mes Cerrado");
        editId=null; editingSplitChildren=null; resetForm(); openSheet(); 
    }
    function openSheet() { document.getElementById('sheet').classList.add('open'); }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); }
    function resetForm() {
        document.getElementById('txForm').reset(); document.getElementById('btnDel').style.display = 'none';
        document.getElementById('splitWarning').style.display = 'none';
        
        const now = new Date(); const y=currentDate.getFullYear(), m=(currentDate.getMonth()+1).toString().padStart(2,'0');
        const d=(y==now.getFullYear() && (currentDate.getMonth())==now.getMonth()) ? now.getDate().toString().padStart(2,'0') : '01';
        document.getElementById('fDate').value = `${y}-${m}-${d}`;
        updateAccountSelects();
        setType('exp'); tempCat=''; tempLink=''; renderLinkChips();
    }
    function updateAccountSelects() {
        const from = document.getElementById('fFromAcc'); const to = document.getElementById('fToAcc');
        from.innerHTML = '<option value="">-- Seleccionar --</option>'; 
        to.innerHTML = '<option value="">-- Seleccionar --</option>';
        data.accounts.forEach(a => {
            const opt = `<option value="${a.id}">${a.name} (${a.currency})</option>`;
            from.innerHTML += opt; to.innerHTML += opt;
        });
    }

    function setType(t) {
        document.getElementById('fType').value = t;
        document.getElementById('seg-exp').className = `tab-btn ${t=='exp'?'active':''}`;
        document.getElementById('seg-inc').className = `tab-btn ${t=='inc'?'active':''}`;
        document.getElementById('seg-trf').className = `tab-btn ${t=='transfer'?'active':''}`;
        
        const divCat = document.getElementById('div-cat');
        const divDesc = document.getElementById('div-desc');
        const linkSec = document.getElementById('linkSection');
        const divFrom = document.getElementById('div-from');
        const divTo = document.getElementById('div-to');

        divCat.style.display = t=='transfer' ? 'none' : 'block';
        divDesc.style.display = t=='transfer' ? 'block' : 'block';
        linkSec.style.display = t=='exp' ? 'block' : 'none';
        
        divFrom.style.display = (t=='exp'||t=='transfer') ? 'block' : 'none';
        divTo.style.display = (t=='inc'||t=='transfer') ? 'block' : 'none';

        if(t!=='transfer') renderCatChips(t);
    }
    
    function renderCatChips(type) {
        const c = document.getElementById('catChips'); c.innerHTML='';
        (data.cats[type]||[]).forEach(cat => {
            const el = document.createElement('div'); el.className=`chip ${tempCat==cat?'active':''}`; el.innerText=cat;
            el.onclick=()=>{ tempCat=cat; document.getElementById('fCat').value=cat; renderCatChips(type); renderConChips(cat); };
            c.appendChild(el);
        });
        const add = document.createElement('div'); add.className='chip'; add.innerHTML='<i class="fas fa-plus"></i>';
        add.onclick=()=>{ const n=prompt('Nueva:'); if(n){ if(!data.cats[type])data.cats[type]=[]; data.cats[type].push(n); data.concepts[n]=[]; saveData(); renderCatChips(type); }};
        c.appendChild(add);
        if(tempCat && (data.cats[type]||[]).includes(tempCat)) renderConChips(tempCat); else document.getElementById('conChips').innerHTML='';
    }
    function renderConChips(cat) {
        const c = document.getElementById('conChips'); c.innerHTML='';
        (data.concepts[cat]||[]).forEach(con => {
            const el=document.createElement('div'); el.className=`chip ${document.getElementById('fConcept').value==con?'active':''}`; el.innerText=con;
            el.onclick=()=>{ document.getElementById('fConcept').value=con; document.getElementById('fCustomDesc').style.display='none'; renderConChips(cat); };
            c.appendChild(el);
        });
        const add=document.createElement('div'); add.className='chip'; add.innerText='...';
        add.onclick=()=>{ document.getElementById('fConcept').value='new'; document.getElementById('fCustomDesc').style.display='block'; document.getElementById('fCustomDesc').focus(); renderConChips(cat); };
        c.appendChild(add);
    }
    function renderLinkChips() {
        const c=document.getElementById('linkChips'); c.innerHTML='';
        const def=document.createElement('div'); def.className=`chip ${!tempLink?'active':''}`; def.innerText='Ninguno';
        def.onclick=()=>{tempLink=''; document.getElementById('fLink').value=''; renderLinkChips();}; c.appendChild(def);
        currentTxs.filter(t=>t.type=='inc').forEach(i=>{
            const el=document.createElement('div'); el.className=`chip ${tempLink==i.id?'active':''}`; el.innerText=i.desc;
            el.onclick=()=>{tempLink=i.id; document.getElementById('fLink').value=i.id; renderLinkChips();}; c.appendChild(el);
        });
    }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        const type = document.getElementById('fType').value;
        let cat = document.getElementById('fCat').value; 
        
        if(editingSplitChildren) {
             cat = "Múltiples";
        } else {
             if(type!=='transfer' && !cat) return alert('Categoría?');
             if(type==='transfer') cat = 'Transferencia';
        }
        
        let desc = document.getElementById('fConcept').value;
        if(type!=='transfer' && !editingSplitChildren && (desc=='new'||!desc)) { 
            desc=document.getElementById('fCustomDesc').value; 
            if(desc && !data.concepts[cat].includes(desc)) data.concepts[cat].push(desc); 
        }
        if(type==='transfer') desc = 'Transferencia';
        if(editingSplitChildren) desc = document.getElementById('fCustomDesc').value || '(Varios)';

        const origAmt = parseFloat(document.getElementById('fAmount').value);
        const curr = document.getElementById('fCurr').value;
        const rates = { ARS: parseFloat(document.getElementById('rateArs').value), COP: parseFloat(document.getElementById('rateCop').value) };
        let amount = origAmt;
        if(curr === 'USD') amount = origAmt * rates.ARS;
        if(curr === 'COP') amount = (origAmt / rates.COP) * rates.ARS;
        
        const tx = {
            id: editId || Date.now(), date: document.getElementById('fDate').value,
            amount: amount, origAmt: origAmt, curr: curr,
            type: type, cat: cat, desc: desc,
            exec: document.getElementById('fExec').checked, linkId: document.getElementById('fLink').value || null,
            fromAccountId: document.getElementById('fFromAcc').value || null,
            toAccountId: document.getElementById('fToAcc').value || null,
            children: editingSplitChildren || []
        };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i>-1) data.txs[i]=tx; } else data.txs.push(tx);
        saveData(); closeSheet();
    };

    function edit(id) {
        if(isMonthClosed()) return alert("Mes Cerrado");
        editId=id; const t=data.txs.find(x=>x.id==id); if(!t)return;
        updateAccountSelects();
        document.getElementById('fAmount').value=t.origAmt||t.amount; document.getElementById('fCurr').value=t.curr||'ARS';
        document.getElementById('fDate').value=t.date; document.getElementById('fExec').checked=t.exec;
        document.getElementById('btnDel').style.display='block';
        
        editingSplitChildren = (t.children && t.children.length > 0) ? t.children : null;
        
        if(editingSplitChildren) {
             document.getElementById('splitWarning').style.display = 'block';
             document.getElementById('splitList').innerHTML = editingSplitChildren.map(c => `<div>- ${c.cat}: ${c.desc} ($${c.amount})</div>`).join('');
             document.getElementById('div-cat').style.display='none';
             document.getElementById('div-desc').style.display='block';
             document.getElementById('conChips').innerHTML=''; 
             document.getElementById('fCustomDesc').style.display='block';
             document.getElementById('fCustomDesc').value = t.desc;
             setType('exp');
        } else {
             document.getElementById('splitWarning').style.display = 'none';
             setType(t.type); 
             if(t.type!=='transfer') {
                tempCat=t.cat; document.getElementById('fCat').value=t.cat; renderCatChips(t.type);
                document.getElementById('fConcept').value=t.desc; renderConChips(t.cat);
                if(!data.concepts[t.cat]?.includes(t.desc)){ document.getElementById('fConcept').value='new'; document.getElementById('fCustomDesc').style.display='block'; document.getElementById('fCustomDesc').value=t.desc; }
                tempLink=t.linkId||''; document.getElementById('fLink').value=tempLink; renderLinkChips();
            }
        }
        
        if(t.fromAccountId) document.getElementById('fFromAcc').value = t.fromAccountId;
        if(t.toAccountId) document.getElementById('fToAcc').value = t.toAccountId;
        openSheet();
    }
    function delTx(){ if(confirm('Eliminar?')){ data.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeSheet(); }}
    
    // --- ALLOC, STATS, SETTINGS ---
    function clearSearch(type) {
        if(type === 'exp') { document.getElementById('searchBar').value = ''; filterExp(); } 
        else { document.getElementById('allocSearch').value = ''; renderAlloc(); }
    }
    function filterExp() {
        const term = document.getElementById('searchBar').value.toLowerCase();
        document.querySelectorAll('#list-exp .tx-card').forEach(r => r.style.display = r.innerText.toLowerCase().includes(term) ? 'block' : 'none');
    }
    function unassignAll() { if(isMonthClosed())return; if(confirm("¿Desvincular TODOS?")) { currentTxs.forEach(t => { if(t.type === 'exp') t.linkId = null; }); saveData(); }}
    function autoAssign() {
        if(isMonthClosed())return;
        if(!confirm("¿Auto-Asignar?")) return;
        let incomes = currentTxs.filter(t => t.type === 'inc').map(i => {
            const assigned = currentTxs.filter(e => e.type === 'exp' && e.linkId == i.id).reduce((a,b)=>a+b.amount,0);
            return { ...i, balance: i.amount - assigned };
        });
        const unassignedExps = currentTxs.filter(t => t.type === 'exp' && !t.linkId);
        let count = 0;
        unassignedExps.forEach(exp => {
            const validIncome = incomes.find(inc => inc.date <= exp.date && inc.balance >= exp.amount);
            if(validIncome) { exp.linkId = validIncome.id; validIncome.balance -= exp.amount; count++; }
        });
        if(count > 0) { alert(`Asignados: ${count}`); saveData(); } else alert("Sin coincidencias");
    }
    function renderAlloc() {
        const c = document.getElementById('alloc-list'); c.innerHTML='';
        const term = document.getElementById('allocSearch').value.toLowerCase();
        const incs = currentTxs.filter(t=>t.type=='inc');
        const exps = currentTxs.filter(t=>t.type=='exp');

        incs.forEach(inc => {
            const subs = exps.filter(e => e.linkId == inc.id);
            const spent = subs.reduce((a,b)=>a+b.amount,0);
            const remaining = inc.amount - spent;
            const pctLeft = Math.max(0, 100 - (inc.amount > 0 ? (spent/inc.amount)*100 : 0));
            const color = remaining >= 0 ? 'var(--inc)' : 'var(--exp)';
            const filteredSubs = term ? subs.filter(s => s.desc.toLowerCase().includes(term)) : subs;
            
            if(term && filteredSubs.length === 0 && !inc.desc.toLowerCase().includes(term)) return;

            const card = document.createElement('div'); card.className='alloc-card';
            let childHTML = '';
            (term ? filteredSubs : subs).forEach(s => {
                const day = s.date.split('-')[2];
                childHTML += `<div class="child-row ${s.exec?'executed':''}" onclick="edit('${s.id}')"><span>${s.desc} <span style="font-size:8px; color:var(--txt-sec);">d-${day}</span></span><span>$${fmt(s.amount)}</span></div>`;
            });
            if(!subs.length) childHTML = '<div class="child-row" style="font-style:italic; color:#cbd5e1; cursor:default;">Sin gastos</div>';
            
            card.innerHTML = `
                <div class="alloc-head">
                    <div onclick="this.closest('.alloc-card').querySelector('.alloc-children').style.display = this.closest('.alloc-card').querySelector('.alloc-children').style.display=='block'?'none':'block'" style="flex:1;">
                        <div style="font-weight:700; font-size:11px;">${inc.desc}</div>
                        <div style="font-size:9px; color:var(--txt-sec);">Ingreso: $${fmt(inc.amount)}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="text-align:right;">
                            <div style="font-weight:800; font-size:11px; color:${color}">$${fmt(remaining)}</div>
                            <div style="font-size:9px; color:var(--txt-sec);">Disponible</div>
                        </div>
                        <i class="fas fa-unlink" style="color:#cbd5e1; font-size:10px; padding:4px;" onclick="unassignGroup('${inc.id}')"></i>
                    </div>
                </div>
                <div class="alloc-prog"><div class="alloc-fill" style="width:${pctLeft}%; background:${color}"></div></div>
                <div class="alloc-children" style="display:${term?'block':'none'}">${childHTML}</div>
            `;
            c.appendChild(card);
        });

        // RESTORED ORPHAN LOGIC
        const orphans = exps.filter(e => !e.linkId);
        const orphansFiltered = term ? orphans.filter(e => e.desc.toLowerCase().includes(term)) : orphans;
        const orphansTotal = orphans.reduce((a,b)=>a+b.amount,0);

        if(orphans.length > 0 && (!term || orphansFiltered.length > 0)) {
             let orphanHTML = '';
             orphansFiltered.forEach(s => {
                  const day = s.date.split('-')[2];
                  orphanHTML += `<div class="child-row ${s.exec?'executed':''}" onclick="edit('${s.id}')"><span>${s.desc} <span style="font-size:8px; color:var(--txt-sec);">d-${day}</span></span><span>$${fmt(s.amount)}</span></div>`;
             });
             c.innerHTML += `
                <div class="alloc-card" style="border-left:4px solid var(--exp);">
                    <div class="alloc-head" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display=='block'?'none':'block'">
                        <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700; width:100%;">
                            <span>Sin Asignar (${orphansFiltered.length})</span>
                            <span style="color:var(--exp);">$${fmt(orphansTotal)}</span>
                        </div>
                    </div>
                    <div class="alloc-children" style="display:none; border-top:1px solid #f1f5f9;">${orphanHTML}</div>
                </div>`;
        }
    }

    function renderStats() {
        renderSpecificChart('exp', drillCatExp, 'chartExp', 'legExp', 'resetExp', 'titleExp', 'Gastos por Categoría');
        renderSpecificChart('inc', drillCatInc, 'chartInc', 'legInc', 'resetInc', 'titleInc', 'Ingresos por Categoría');
    }
    function renderSpecificChart(type, drillCat, canvasId, legendId, resetBtnId, titleId, defaultTitle) {
        let txs = currentTxs.filter(t => t.type == type);
        let key = 'cat';
        if(drillCat) {
            document.getElementById(resetBtnId).style.display = 'block';
            document.getElementById(titleId).innerText = drillCat;
            txs = txs.filter(t => t.cat === drillCat); key = 'desc'; 
        } else {
            document.getElementById(resetBtnId).style.display = 'none';
            document.getElementById(titleId).innerText = defaultTitle;
        }
        renderDoughnut(document.getElementById(canvasId), document.getElementById(legendId), txs, key, type);
    }
    function renderDoughnut(cvs, leg, txs, key, type) {
        let map={}; txs.forEach(t=>{ const k=t[key]||'Gral'; map[k]=(map[k]||0)+t.amount; });
        const ent = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const tot = ent.reduce((a,b)=>a+b[1],0);
        const chartInstance = Chart.getChart(cvs);
        if(chartInstance) chartInstance.destroy();
        new Chart(cvs, {
            type: 'doughnut',
            data: { labels: ent.map(e=>e[0]), datasets: [{ data: ent.map(e=>e[1]), backgroundColor: PALETTE, borderWidth:0 }] },
            options: { 
                responsive:true, maintainAspectRatio:false, cutout:'70%', animation: { duration: 0 }, plugins:{legend:{display:false}}, 
                onClick:(e,el)=>{ if(el.length > 0) { const idx = el[0].index; const selected = ent[idx][0]; if(type === 'exp' && !drillCatExp) { drillCatExp = selected; renderStats(); } if(type === 'inc' && !drillCatInc) { drillCatInc = selected; renderStats(); } } }
            } 
        });
        leg.innerHTML = '';
        ent.forEach((e,i) => {
            const pct = tot > 0 ? Math.round((e[1]/tot)*100) : 0;
            leg.innerHTML += `<div class="legend-item" onclick="if('${type}'=='exp' && !drillCatExp){drillCatExp='${e[0]}';renderStats();} if('${type}'=='inc' && !drillCatInc){drillCatInc='${e[0]}';renderStats();}"><div style="display:flex; align-items:center; flex:1; min-width:0;"><div class="legend-dot" style="background:${PALETTE[i%PALETTE.length]}"></div><div class="legend-name">${e[0]}</div></div><div style="display:flex; align-items:center; gap:6px;"><span style="font-size:8px; color:var(--txt-sec);">${pct}%</span><span style="font-weight:700; font-size:10px; color:var(--txt);">$${fmt(e[1])}</span></div></div>`;
        });
    }
    function resetChart(type) { if(type === 'exp') drillCatExp = null; if(type === 'inc') drillCatInc = null; renderStats(); }

    function renderRecurrentesList() {
        const c = document.getElementById('list-recurrentes'); c.innerHTML='';
        if(!data.recurrentes.length) { c.innerHTML='<div style="text-align:center; color:#cbd5e1; font-size:9px;">Sin datos</div>'; return; }
        
        const groups = {};
        data.recurrentes.forEach((r, idx) => {
             const cat = r.cat || 'Varios';
             if(!groups[cat]) groups[cat] = [];
             groups[cat].push({ ...r, idx }); 
        });

        Object.keys(groups).forEach(cat => {
            const node = document.createElement('div'); node.className='tree-node';
            const items = groups[cat];
            
            let itemsHtml = items.map(item => `
                <div style="display:flex; justify-content:space-between; padding:4px 8px; border-bottom:1px solid #f1f5f9; font-size:10px; align-items:center;">
                    <span onclick="editRecurrente(${item.idx})">${item.desc}</span>
                    <div style="display:flex; gap:8px;">
                        <b>$${fmt(item.amount)}</b>
                        <i class="fas fa-trash" style="color:#cbd5e1; cursor:pointer;" onclick="delRecurrente(${item.idx})"></i>
                    </div>
                </div>
            `).join('');

            node.innerHTML = `
                <div class="tree-head" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='block'?'none':'block'">
                    <span>${cat} <span style="font-weight:400; color:#94a3b8;">(${items.length})</span></span>
                </div>
                <div class="tree-body" style="display:block; padding:0;">${itemsHtml}</div>
            `;
            c.appendChild(node);
        });
    }
    function addRecurrenteUI() {
        if(isMonthClosed())return;
        const desc = prompt("Nombre:"); if(!desc) return;
        const amount = prompt("Monto:"); if(!amount) return;
        data.recurrentes.push({ desc: desc, amount: parseFloat(amount), cat: 'Esenciales', type: 'exp' });
        saveData(); renderSettings();
    }
    function editRecurrente(i) {
        if(isMonthClosed())return;
        const r = data.recurrentes[i];
        const newAmt = prompt('Nuevo monto para '+r.desc+':', r.amount);
        if(newAmt) { data.recurrentes[i].amount = parseFloat(newAmt); saveData(); renderSettings(); }
    }
    function delRecurrente(i) {
        if(isMonthClosed())return;
        if(confirm('Borrar recurrente?')) { data.recurrentes.splice(i,1); saveData(); renderSettings(); }
    }

    function renderAdminTree() {
        const c = document.getElementById('admin-tree'); c.innerHTML='';
        
        // CONFIGURACION DE INGRESOS Y EGRESOS
        [{k:'exp', label:'Gastos'},{k:'inc', label:'Ingresos'}].forEach(type => {
            (data.cats[type.k]||[]).forEach(cat => {
                const node = document.createElement('div'); node.className='tree-node';
                const concepts = data.concepts[cat]||[];
                node.innerHTML = `<div class="tree-head" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='flex'?'none':'flex'"><span>${cat} <span style="font-weight:400; color:#94a3b8;">(${type.label} - ${concepts.length})</span></span><i class="fas fa-trash" style="color:#cbd5e1; font-size:9px;" onclick="event.stopPropagation();delCat('${type.k}','${cat}')"></i></div><div class="tree-body">${concepts.map(con => `<div class="concept-tag">${con} <i class="fas fa-times" style="color:#cbd5e1; cursor:pointer;" onclick="delCon('${cat}','${con}')"></i></div>`).join('')}<div class="concept-tag" style="background:white; border:1px dashed #cbd5e1; color:var(--accent); cursor:pointer;" onclick="addCon('${cat}')">+</div></div>`;
                c.appendChild(node);
            });
        });

        // NUEVA SECCION: TIPOS DE CUENTA (PATRIMONIO)
        const nodeAcc = document.createElement('div'); nodeAcc.className='tree-node';
        const accCats = data.accountCats || [];
        nodeAcc.innerHTML = `
            <div class="tree-head" style="background:#EEF2FF; color:#312E81;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='flex'?'none':'flex'">
                <span>Tipos de Cuenta <span style="font-weight:400;">(${accCats.length})</span></span>
            </div>
            <div class="tree-body">
                ${accCats.map(cat => `<div class="concept-tag">${cat} <i class="fas fa-trash" style="color:#cbd5e1; cursor:pointer;" onclick="delAccCat('${cat}')"></i></div>`).join('')}
                <div class="concept-tag" style="background:white; border:1px dashed #cbd5e1; color:var(--accent); cursor:pointer;" onclick="addAccCat()">+</div>
            </div>
        `;
        c.appendChild(nodeAcc);
    }
    
    function delCat(t,c){ if(isMonthClosed())return; if(confirm('Borrar?')) { data.cats[t]=data.cats[t].filter(x=>x!==c); delete data.concepts[c]; saveData(); renderSettings(); }}
    function delCon(c,n){ if(isMonthClosed())return; if(confirm('Borrar?')) { data.concepts[c]=data.concepts[c].filter(x=>x!==n); saveData(); renderSettings(); }}
    function addCon(c){ if(isMonthClosed())return; const n=prompt('Nueva:'); if(n){ if(!data.concepts[c])data.concepts[c]=[]; data.concepts[c].push(n); saveData(); renderSettings(); }}
    
    // FUNCIONES PARA TIPOS DE CUENTA
    function delAccCat(c){ if(isMonthClosed())return; if(confirm('¿Borrar tipo de cuenta?')) { data.accountCats = data.accountCats.filter(x=>x!==c); saveData(); renderSettings(); }}
    function addAccCat(){ if(isMonthClosed())return; const n=prompt('Nuevo Tipo de Cuenta:'); if(n){ if(!data.accountCats)data.accountCats=[]; data.accountCats.push(n); saveData(); renderSettings(); }}

    function executeRecurrentes() {
        if(isMonthClosed())return;
        const txt = document.getElementById('monthTxt').innerText; if(!confirm(`¿Ejecutar en ${txt}?`)) return;
        const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; let c=0;
        data.recurrentes.forEach(r=>{
            if(!data.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){
                 data.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, curr:'ARS'}); c++;
            }
        });
        alert(c>0 ? `Generados ${c}` : 'Ya estaban'); saveData();
    }
    
    // --- UTILS & MONTH CLOSE ---
    function toggleMonthClose() {
        const key = getKey();
        if(data.closedMonths[key]) {
            if(confirm("¿Reabrir mes?")) { delete data.closedMonths[key]; saveData(); }
        } else {
            if(confirm("¿Cerrar mes? No podrás editar.")) { data.closedMonths[key] = true; saveData(); }
        }
    }

    function cloneTx(id) {
        if(isMonthClosed()) return alert("Mes Cerrado");
        const t = data.txs.find(x => x.id == id); if(!t) return;
        if(!confirm("¿Clonar " + t.desc + "?")) return;
        const currentY = currentDate.getFullYear();
        const currentM = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        const newDate = `${currentY}-${currentM}-${t.date.split('-')[2]}`;
        const newTx = {...t, id: Date.now(), date: newDate, exec: false};
        data.txs.push(newTx); saveData();
    }
    function openCloneModal() {
        if(isMonthClosed()) return alert("Mes Cerrado");
        const sel = document.getElementById('selCloneSrc'); sel.innerHTML = '';
        const months = new Set(); data.txs.forEach(t => { if(!t.deletedAt) months.add(t.date.slice(0, 7)); });
        Array.from(months).sort().reverse().forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.innerText = m; sel.appendChild(opt); });
        document.getElementById('modalClone').classList.add('open');
    }
    function doCloneMonth() {
        const srcMonth = document.getElementById('selCloneSrc').value; if(!srcMonth) return;
        const srcTxs = data.txs.filter(t => !t.deletedAt && t.date.startsWith(srcMonth)); if(srcTxs.length === 0) return alert('Mes vacío');
        const targetY = currentDate.getFullYear(); const targetM = (currentDate.getMonth() + 1).toString().padStart(2,'0');
        const mapIds = {}; const newTxs = [];
        srcTxs.filter(t => t.type === 'inc').forEach(t => { const newId = Date.now() + Math.random(); mapIds[t.id] = newId; newTxs.push({...t, id: newId, date: `${targetY}-${targetM}-01`, exec: false}); });
        srcTxs.filter(t => t.type === 'exp').forEach(t => { newTxs.push({...t, id: Date.now() + Math.random(), date: `${targetY}-${targetM}-01`, exec: false, linkId: t.linkId ? mapIds[t.linkId] : null }); });
        data.txs.push(...newTxs); saveData(); document.getElementById('modalClone').classList.remove('open');
    }
    function clearMonth(){ 
        if(isMonthClosed()) return alert("Mes Cerrado");
        if(confirm('¿Borrar TODO este mes?')) { const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; data.txs.forEach(t=>{ if(parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m) t.deletedAt=Date.now(); }); saveData(); }
    }
    function nav(v) {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(`view-${v}`).classList.add('active');
        document.getElementById(`nav-${v}`).classList.add('active');
        if(v=='networth') renderNetWorth();
        if(v=='stats') renderStats(); if(v=='settings') renderSettings();
    }
    function setSubTab(t) {
        document.getElementById('sec-txs').style.display=t=='txs'?'flex':'none';
        document.getElementById('sec-alloc').style.display=t=='alloc'?'block':'none';
        document.getElementById('tab-txs').className=`tab-btn ${t=='txs'?'active':''}`;
        document.getElementById('tab-alloc').className=`tab-btn ${t=='alloc'?'active':''}`;
    }
    
    async function forceSync() {
        const syncDot = document.getElementById('syncDot');
        syncDot.className = 'sync-dot sync-spin'; 
        
        try { 
            const r = await fetch(API_URL + '?t=' + Date.now(), { cache: "no-store" }); 
            const d = await r.json(); 
            
            if(d) { 
                data.txs = d.txs || []; 
                data.accounts = d.accounts || [];
                data.cats = d.cats || data.cats; 
                data.concepts = d.concepts || data.concepts; 
                data.recurrentes = d.recurrentes || []; 
                data.monthlyRates = d.monthlyRates || {}; 
                data.closedMonths = d.closedMonths || {};
                data.accountCats = d.accountCats || ['Efectivo', 'Banco', 'Inversiones', 'Cripto', 'Tarjeta', 'Otro'];
                
                localStorage.setItem('finance_mobile_data_v17', JSON.stringify(data));
                refreshAll(); 
                
                syncDot.className = 'sync-dot';
                syncDot.style.background='#10B981'; 
            } 
        } catch(e){ 
            console.error(e); 
            syncDot.className = 'sync-dot';
            syncDot.style.background='#EF4444'; 
        }
    }

    function saveData() {
        localStorage.setItem('finance_mobile_data_v17', JSON.stringify(data));
        refreshAll(); 

        const syncDot = document.getElementById('syncDot');
        syncDot.style.background='#F59E0B'; 

        if(saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
            fetch(API_URL, {
                method: 'POST', 
                mode: 'no-cors', 
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            }).then(() => {
                 syncDot.style.background='#10B981'; 
            }).catch(e => {
                 console.error(e);
                 syncDot.style.background='#EF4444'; 
            });
        }, 500); 
    }
</script>
</body>
</html>
