<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>FinanceFlow UI | Javi</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { 
                        "primary": "#0e757c", 
                        "primary-dark": "#085055", 
                        "income": "#10B981",
                        "expense": "#EF4444",
                        "background-light": "#f8fafc",
                        "background-dark": "#17191c",
                        "hero-dark": "#262E3B"
                    },
                    fontFamily: { 
                        "display": ["Manrope", "sans-serif"], 
                        "body": ["Inter", "sans-serif"] 
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'floating': '0 20px 40px -10px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Manrope', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Glassmorphism Classes */
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-top: 1px solid rgba(255,255,255,0.5); }
        .glass-panel { background: white; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); border-radius: 1rem; }
        .hero-gradient { background-image: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .hidden-view { display: none !important; }
        .active-tab { color: #0e757c; }
        .active-tab span { font-variation-settings: 'FILL' 1; }
        
        /* Inputs TC Clean */
        .tc-input { -moz-appearance: textfield; background: transparent; border: none; padding: 0; font-weight: 700; color: white; text-align: right; width: 45px; font-size: 12px; }
        .tc-input:focus { outline: none; border-bottom: 1px solid rgba(255,255,255,0.5); }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Date Picker Invisible Overlay */
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; height: 100%; }
        
        /* Chips */
        .chip { border: 1px solid #e2e8f0; background: white; padding: 6px 12px; border-radius: 99px; font-size: 11px; font-weight: 600; color: #64748b; transition: all 0.2s; }
        .chip.active { background: #0e757c; color: white; border-color: #0e757c; box-shadow: 0 4px 12px rgba(14, 117, 124, 0.3); }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>

<body class="text-slate-900 h-screen flex flex-col overflow-hidden bg-background-light selection:bg-primary/20">

    <header class="pt-12 pb-4 px-5 bg-white sticky top-0 z-30 shadow-sm transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-full bg-slate-100 flex items-center justify-center">
                    <span class="material-symbols-outlined text-slate-600">person</span>
                </div>
                <div>
                    <h1 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Bienvenido</h1>
                    <h2 class="text-lg font-extrabold text-slate-800 leading-none">Javi</h2>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-slate-900 text-white px-3 py-1.5 rounded-full shadow-lg shadow-slate-900/20">
                <span class="text-[10px] font-bold text-slate-400">USD</span>
                <input type="number" id="rate_ARS" onchange="saveMonthlyRates()" class="tc-input" placeholder="0">
                <div class="w-px h-3 bg-slate-700 mx-1"></div>
                <span class="text-[10px] font-bold text-slate-400">COP</span>
                <input type="number" id="rate_COP" step="0.01" onchange="saveMonthlyRates()" class="tc-input" placeholder="0">
            </div>
        </div>

        <div class="flex justify-center mb-1 relative z-20">
             <div class="flex items-center gap-2 bg-slate-100 px-4 py-1.5 rounded-full hover:bg-slate-200 transition-colors relative">
                <span class="material-symbols-outlined text-primary text-[18px]">calendar_month</span>
                <span class="text-sm font-bold text-slate-700" id="monthTxt">...</span>
                <span class="material-symbols-outlined text-slate-400 text-[18px]">expand_more</span>
                <input type="month" id="datePicker" class="d-picker" onchange="manualDate()">
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto custom-scrollbar pb-32 px-5 pt-2" id="main-scroll">
        
        <div id="view-dashboard" class="view-container animate-enter space-y-5">
            
            <div class="hero-gradient rounded-2xl p-5 shadow-xl shadow-slate-900/20 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <span class="material-symbols-outlined text-9xl">account_balance_wallet</span>
                </div>
                <div class="relative z-10">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Balance Neto</p>
                    <h3 class="text-4xl font-black tracking-tight mb-4" id="k-bal">$0</h3>
                    
                    <div class="flex items-center gap-4">
                        <div class="bg-white/10 px-3 py-1.5 rounded-lg flex items-center gap-2 backdrop-blur-sm">
                            <span class="material-symbols-outlined text-emerald-400 text-lg">trending_up</span>
                            <div>
                                <p class="text-[9px] text-slate-300 uppercase font-bold">Ingresos</p>
                                <p class="text-xs font-bold text-emerald-400" id="k-inc">$0</p>
                            </div>
                        </div>
                        <div class="bg-white/10 px-3 py-1.5 rounded-lg flex items-center gap-2 backdrop-blur-sm">
                            <span class="material-symbols-outlined text-rose-400 text-lg">trending_down</span>
                            <div>
                                <p class="text-[9px] text-slate-300 uppercase font-bold">Gastos</p>
                                <p class="text-xs font-bold text-rose-400" id="k-exp">$0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center">
                <div class="bg-blue-50 text-blue-700 px-4 py-1 rounded-full text-xs font-bold border border-blue-100 shadow-sm flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">savings</span>
                    Est. USD: <span id="k-usd">$0</span>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Movimientos</h3>
                    <button class="text-primary text-xs font-bold hover:underline" onclick="nav('analytics')">Ver Stats</button>
                </div>
                <div class="space-y-3" id="list-txs">
                    </div>
            </div>
        </div>

        <div id="view-analytics" class="view-container animate-enter hidden-view space-y-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800">Gastos vs Ingresos</h3>
                    <button onclick="resetCharts()" id="resetBtn" class="hidden text-xs text-primary font-bold bg-primary/10 px-2 py-1 rounded">Reset</button>
                </div>
                <div class="relative h-[220px] w-full flex justify-center">
                    <canvas id="chartExp"></canvas>
                </div>
                <div id="legExp" class="mt-4 space-y-2 max-h-[150px] overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-sm font-bold text-slate-800 mb-4">Ingresos por Concepto</h3>
                <div class="relative h-[200px] w-full flex justify-center">
                    <canvas id="chartInc"></canvas>
                </div>
            </div>
        </div>

        <div id="view-strategy" class="view-container animate-enter hidden-view space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-sm font-bold text-slate-800 mb-6 text-center uppercase tracking-wide">Regla 50/30/20</h3>
                <div class="flex justify-center mb-2">
                    <canvas id="chartRadar" style="max-height: 250px;"></canvas>
                </div>
                <p class="text-center text-xs text-slate-400">Distribución ideal vs real</p>
            </div>

             <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center">
                 <div class="inline-flex size-14 rounded-full bg-slate-50 items-center justify-center mb-3">
                    <span class="material-symbols-outlined text-3xl text-primary">hub</span>
                 </div>
                 <h3 class="text-sm font-bold text-slate-800">Portafolio Inversiones</h3>
                 <p class="text-xs text-slate-400 mt-1 mb-4">Conexión API Lista</p>
                 <div class="bg-slate-50 rounded-lg p-3 text-xs text-slate-500 font-mono">
                    Waiting for data stream...
                 </div>
             </div>
        </div>

        <div id="view-settings" class="view-container animate-enter hidden-view space-y-5">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">folder</span> Categorías
                </h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newCatName" placeholder="Nueva..." class="flex-1 bg-slate-50 border-none rounded-lg text-xs px-3 focus:ring-1 focus:ring-primary">
                    <select id="newCatType" class="bg-slate-50 border-none rounded-lg text-xs px-2 text-slate-600"><option value="exp">Gasto</option><option value="inc">Ingreso</option></select>
                    <button onclick="manualAddCat()" class="bg-slate-800 text-white size-8 rounded-lg flex items-center justify-center shadow-md">+</button>
                </div>
                <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar" id="adminTreeContainer"></div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined text-primary">update</span> Recurrentes</h3>
                    <button onclick="addRecurrenteRow()" class="text-primary text-xs font-bold">+ Agregar</button>
                </div>
                <div class="space-y-2 mb-4" id="recurrente-table-body"></div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveRecurrentesConfig()" class="py-2.5 rounded-xl bg-slate-100 text-slate-600 text-xs font-bold">Guardar</button>
                    <button onclick="executeRecurrentes()" class="py-2.5 rounded-xl bg-slate-800 text-white text-xs font-bold shadow-lg shadow-slate-900/20">Ejecutar Mes</button>
                </div>
            </div>
            
            <div class="pt-4 border-t border-slate-100">
                <button onclick="clearMonth()" class="w-full py-3 rounded-xl border border-red-100 text-red-500 text-xs font-bold hover:bg-red-50 transition-colors">Borrar Mes Actual</button>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 glass-nav rounded-2xl shadow-floating px-4 py-3 z-50 flex justify-between items-center max-w-md mx-auto">
        <button onclick="nav('dashboard', this)" class="nav-btn active-tab flex flex-col items-center gap-1 text-slate-400 w-12 transition-colors">
            <span class="material-symbols-outlined text-2xl">grid_view</span>
        </button>
        <button onclick="nav('analytics', this)" class="nav-btn flex flex-col items-center gap-1 text-slate-400 w-12 transition-colors">
            <span class="material-symbols-outlined text-2xl">bar_chart</span>
        </button>
        
        <button onclick="openModal()" class="relative -top-8 bg-slate-900 text-white rounded-2xl p-4 shadow-xl shadow-slate-900/40 hover:scale-105 active:scale-95 transition-transform border-4 border-[#f8fafc]">
            <span class="material-symbols-outlined text-3xl">add</span>
        </button>

        <button onclick="nav('strategy', this)" class="nav-btn flex flex-col items-center gap-1 text-slate-400 w-12 transition-colors">
            <span class="material-symbols-outlined text-2xl">pie_chart</span>
        </button>
        <button onclick="nav('settings', this)" class="nav-btn flex flex-col items-center gap-1 text-slate-400 w-12 transition-colors">
            <span class="material-symbols-outlined text-2xl">settings</span>
        </button>
    </nav>

    <div id="modalOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="relative z-10 w-full max-w-[380px] bg-white rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-enter max-h-[85vh]">
            <div class="flex items-center justify-between px-6 pt-6 pb-2">
                <h1 class="text-xl font-bold text-slate-800" id="mTitle">Nuevo</h1>
                <button onclick="closeModal()" class="size-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>
            
            <form id="txForm" class="p-6 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-2 p-1 bg-slate-100 rounded-2xl mb-5">
                    <button type="button" id="btnExp" onclick="setType('exp')" class="py-2.5 rounded-xl text-xs font-bold transition-all shadow-sm bg-white text-expense">Gasto</button>
                    <button type="button" id="btnInc" onclick="setType('inc')" class="py-2.5 rounded-xl text-xs font-bold transition-all text-slate-400">Ingreso</button>
                </div>
                <input type="hidden" id="fType" value="exp">

                <div class="flex gap-3 mb-5">
                    <div class="flex-1 relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl">$</span>
                        <input type="number" id="fAmt" step="0.01" class="w-full pl-8 pr-4 py-4 bg-slate-50 border-2 border-transparent focus:bg-white focus:border-primary rounded-2xl text-2xl font-bold text-slate-800 outline-none text-right" placeholder="0" required oninput="calcConversion()">
                    </div>
                    <div class="w-24">
                        <select id="fCurr" onchange="calcConversion()" class="w-full h-full bg-slate-100 border-transparent rounded-2xl text-xs font-bold focus:ring-0 text-center">
                            <option value="ARS">ARS</option>
                            <option value="USD">USD</option>
                            <option value="COP">COP</option>
                        </select>
                    </div>
                </div>
                <div id="convPreview" class="hidden text-right text-xs text-slate-500 font-medium -mt-3 mb-4 pr-1">
                    = <span id="convResult" class="text-slate-800 font-bold">$0 ARS</span>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Fecha</label>
                        <input type="date" id="fDate" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-sm font-bold text-slate-700" required>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Categoría</label>
                        <div class="flex flex-wrap gap-2" id="chipBox"></div>
                        <input type="hidden" id="fCat">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1" id="lblDesc">Concepto</label>
                        <div class="flex flex-wrap gap-2 mb-2" id="conceptBox"></div>
                        <input type="text" id="fDesc" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-sm placeholder:text-slate-400 focus:ring-2 focus:ring-primary/20" placeholder="Descripción..." required>
                    </div>
                    
                    <div id="linkRow">
                         <label class="block text-[10px] font-bold text-primary uppercase mb-1.5 ml-1">Pagar con</label>
                         <div id="linkChipsContainer" class="flex flex-wrap gap-2"></div>
                         <input type="hidden" id="fLink">
                    </div>

                    <div class="flex items-center gap-3 p-3 border border-slate-100 rounded-xl bg-white shadow-sm cursor-pointer" onclick="document.getElementById('fExec').click()">
                        <input type="checkbox" id="fExec" class="size-5 text-primary rounded border-slate-300 focus:ring-primary">
                        <div>
                            <span class="block text-xs font-bold text-slate-700">Ejecutado</span>
                            <span class="block text-[10px] text-slate-400">Congelar tasa de cambio</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex flex-col gap-3">
                    <button type="submit" class="w-full py-4 rounded-2xl bg-slate-900 text-white text-sm font-bold shadow-xl shadow-slate-900/20 active:scale-95 transition-all">GUARDAR</button>
                    <button type="button" id="btnDel" onclick="delTx()" class="text-xs text-red-500 font-bold py-2 hidden">Eliminar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === URL DEL SCRIPT ===
        const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
        
        const MONTHS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const PALETTE = ['#0e757c','#10B981','#F59E0B','#EF4444','#6366F1','#8B5CF6','#EC4899','#64748b'];

        const defaultData = { 
            txs: [], 
            cats: { 
                exp:['Esenciales','Deudas','Fitness','Viaje Italia','Inversiones','Proyectos'], 
                inc:['Sueldo Famiq','Honorarios','Rentas','Otros'] 
            }, 
            concepts: {
                'Esenciales': ['Alquiler','Expensas','Supermercado','Luz','Gas','Internet'],
                'Deudas': ['Prestamo 11M','Visa','Mastercard'],
                'Fitness': ['Cuota Gym','Proteína','Creatina','Ropa Deportiva'],
                'Viaje Italia': ['Fondo Ahorro','Pasajes','Alojamiento'],
                'Inversiones': ['Plan 500 USD','CEDEARs','Crypto'],
                'Proyectos': ['ALEJEN Pediátrica','App Finance'],
                'Sueldo Famiq': ['Mensual','Bono'],
                'Honorarios': ['Consultas Dra','Particulares']
            }, 
            recurrentes: [], 
            monthlyRates: {} 
        };

        let appData = JSON.parse(JSON.stringify(defaultData)); 
        let currentDate = new Date(); currentDate.setDate(1);
        let editId=null, cExp=null, cInc=null, drillCat=null, cRadar=null;
        const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        window.onload = () => { initApp(); };

        async function initApp() {
            loadLocal();
            await forceSync();
            updateDateUI(); 
            Chart.defaults.font.family = "'Manrope', sans-serif";
            renderAdminTree();
        }

        function saveLocal() { localStorage.setItem('financeFlowData_Javi', JSON.stringify(appData)); }
        function loadLocal() {
            const stored = localStorage.getItem('financeFlowData_Javi');
            if(stored) { try { appData = JSON.parse(stored); } catch(e){ } }
            loadMonthData();
        }

        async function forceSync() {
            try { 
                const r = await fetch(API_URL); 
                const cloudData = await r.json(); 
                if(cloudData) {
                    appData.txs = cloudData.txs || [];
                    appData.cats = cloudData.cats || defaultData.cats;
                    appData.concepts = cloudData.concepts || defaultData.concepts; 
                    appData.rates = cloudData.rates || {}; 
                    appData.monthlyRates = cloudData.monthlyRates || appData.rates; 
                    appData.recurrentes = cloudData.recurrentes || [];
                    saveLocal();
                }
            } catch(e) { console.log("Offline mode"); }
            loadMonthData(); 
        }
        
        async function saveData() {
            saveLocal();
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); } catch(e){}
            loadMonthData(); renderAdminTree();
        }

        function loadMonthData() {
            const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
            const key = `${y}-${m.toString().padStart(2,'0')}`;
            
            let rates = appData.monthlyRates[key] || { ARS: 1200, COP: 4200, USD: 1 };
            document.getElementById('rate_ARS').value = rates.ARS; 
            document.getElementById('rate_COP').value = rates.COP;
            
            const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
            
            txs.forEach(t => {
                if (!t.exec && t.origCurr && t.origCurr !== 'ARS') {
                    if (t.origCurr === 'USD') t.amount = t.origAmt * rates.ARS;
                    else if (t.origCurr === 'COP') t.amount = (t.origAmt / rates.COP) * rates.ARS;
                }
            });

            txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
            renderLists(txs); renderCharts(txs); updateKPIs(txs); renderRecurrentesAdmin(); renderAdminTree();
        }

        // --- RENDER LISTS (DISEÑO TARJETAS TIPO IOS) ---
        function renderLists(txs) {
            const container = document.getElementById('list-txs');
            container.innerHTML = '';
            
            if(txs.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-10 opacity-50"><span class="material-symbols-outlined text-4xl mb-2">inbox</span><p class="text-xs">Sin movimientos</p></div>`;
                return;
            }

            let rb = 0;
            
            txs.forEach(t => {
                if(t.type=='inc') rb+=t.amount; else rb-=t.amount;
                
                const isInc = t.type === 'inc';
                const colorClass = isInc ? 'text-income' : 'text-expense';
                const iconBg = isInc ? 'bg-emerald-50' : 'bg-red-50';
                const iconColor = isInc ? 'text-emerald-600' : 'text-red-600';
                const icon = isInc ? 'trending_up' : 'shopping_bag';
                
                let currBadge = (t.origCurr && t.origCurr !== 'ARS') ? `<span class="bg-slate-100 text-slate-500 text-[9px] px-1.5 py-0.5 rounded ml-1 font-bold">${t.origAmt} ${t.origCurr}</span>` : '';
                
                let linkText = '';
                if(!isInc && t.linkId) { 
                    const source = appData.txs.find(x => x.id == t.linkId); 
                    if(source) linkText = `<span class="flex items-center gap-0.5 bg-blue-50 text-blue-600 text-[9px] px-1.5 py-0.5 rounded font-bold"><span class="material-symbols-outlined text-[10px]">link</span>${source.desc.substring(0,6)}..</span>`; 
                }

                const el = document.createElement('div');
                // Efecto "Swipe" visual si está ejecutado o pending
                const statusBadge = t.exec 
                    ? `<span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full">Ejecutado</span>`
                    : `<button onclick="quickExecute(event, ${t.id})" class="flex items-center gap-1 text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full hover:bg-blue-100 transition-colors z-20"><span class="material-symbols-outlined text-[12px]">check</span> Pendiente</button>`;

                el.className = `relative w-full bg-white rounded-2xl shadow-card p-4 flex items-center justify-between border border-slate-50 active:scale-[0.99] transition-transform`;
                el.onclick = (e) => { if(!e.target.closest('button')) editTx(t.id); };
                
                el.innerHTML = `
                    <div class="flex items-center gap-4 overflow-hidden">
                        <div class="size-12 rounded-xl ${iconBg} flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined ${iconColor}">${icon}</span>
                        </div>
                        <div class="flex flex-col min-w-0">
                            <div class="flex items-center gap-1">
                                <span class="text-sm font-bold text-slate-800 truncate">${t.desc}</span>
                                ${linkText}
                            </div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[10px] text-slate-500 font-medium">${t.cat}</span>
                                <span class="text-[10px] text-slate-400">• ${t.date.split('-')[2]}</span>
                                ${currBadge}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-base font-bold ${colorClass}">${isInc?'+':'-'}$${fmt(t.amount)}</span>
                        ${statusBadge}
                    </div>
                `;
                container.appendChild(el);
            });
            
            // Stats pills
            document.getElementById('c-inc').innerText = '$'+fmt(txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0));
            document.getElementById('c-exp').innerText = '$'+fmt(txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0));
        }

        function updateKPIs(txs){ 
            const tc=parseFloat(document.getElementById('rate_ARS').value)||1200; 
            const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0); 
            const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0); 
            const bal = i-e;
            
            document.getElementById('k-inc').innerText='$'+fmt(i); 
            document.getElementById('k-exp').innerText='$'+fmt(e); 
            
            const balEl = document.getElementById('k-bal');
            balEl.innerText = '$'+fmt(bal);
            
            document.getElementById('k-usd').innerText='$'+fmt(bal/tc); 
        }

        // --- QUICK ACTIONS ---
        function quickExecute(e, id) {
            e.stopPropagation();
            const tx = appData.txs.find(t => t.id === id);
            if(tx) {
                tx.exec = true;
                // Al ejecutar desde la lista, congelamos al valor actual calculado
                // Si la moneda es USD, ya está convertida en UI, pero en data 'amount' es dinámico si !exec.
                // Aquí forzamos el recalculo y guardado estático.
                const rates = { ARS: parseFloat(document.getElementById('rate_ARS').value), COP: parseFloat(document.getElementById('rate_COP').value) };
                if (tx.origCurr === 'USD') tx.amount = tx.origAmt * rates.ARS;
                else if (tx.origCurr === 'COP') tx.amount = (tx.origAmt / rates.COP) * rates.ARS;
                
                saveData();
            }
        }

        // --- CHARTS & OTHERS ---
        function renderCharts(txs) {
            renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), txs.filter(t=>t.type=='exp'), 'cat', true, cExp, i=>cExp=i);
            renderDoughnut(document.getElementById('chartInc'), null, txs.filter(t=>t.type=='inc'), 'desc', false, cInc, i=>cInc=i);
            
            if(cRadar) cRadar.destroy();
            const totalInc = txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0) || 1;
            const savings = txs.filter(t=>['Inversiones','Viaje Italia','Ahorro'].includes(t.cat)).reduce((a,b)=>a+b.amount,0);
            const fixed = txs.filter(t=>['Esenciales','Deudas','Sueldo Famiq'].includes(t.cat)).reduce((a,b)=>a+b.amount,0); 
            const variable = txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0) - (savings + fixed);

            cRadar = new Chart(document.getElementById('chartRadar'), { 
                type: 'radar', 
                data: { 
                    labels: ['Fijos (50%)', 'Ocio (30%)', 'Ahorro (20%)'], 
                    datasets: [
                        { label: 'Ideal', data: [50, 30, 20], borderColor: '#cbd5e1', borderDash: [5,5], fill: false, pointRadius: 0 },
                        { label: 'Real', data: [Math.min(100, (fixed/totalInc)*100), Math.min(100, (variable/totalInc)*100), Math.min(100, (savings/totalInc)*100)], backgroundColor: 'rgba(14, 117, 124, 0.2)', borderColor: '#0e757c', fill: true }
                    ] 
                }, 
                options: { scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { position: 'top' } } } 
            });
        }

        function renderDoughnut(cvs, leg, data, key, drill, inst, setInst) {
            if(inst) inst.destroy();
            let map={}; if(drill && drillCat) { document.getElementById('resetBtn').classList.remove('hidden'); data.filter(t=>t.cat==drillCat).forEach(t=>map[t.desc]=(map[t.desc]||0)+t.amount); } else { if(drill) document.getElementById('resetBtn').classList.add('hidden'); data.forEach(t=>{ const k = t[key] || 'General'; map[k]=(map[k]||0)+t.amount; }); }
            const ent = Object.entries(map).sort((a,b)=>b[1]-a[1]); const tot = ent.reduce((a,b)=>a+b[1],0);
            
            setInst(new Chart(cvs, { 
                type:'doughnut', 
                data:{ labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0, hoverOffset:4}] }, 
                options:{ 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    cutout:'75%', 
                    plugins:{legend:{display:false}}, 
                    layout: { padding: 10 },
                    onClick:(e,el)=>{if(drill&&!drillCat&&el.length){drillCat=ent[el[0].index][0]; loadMonthData();}} 
                } 
            }));
            
            if(leg) {
                leg.innerHTML = ''; 
                ent.forEach((e,i) => { 
                    const pct = Math.round((e[1]/tot)*100); 
                    leg.innerHTML += `
                        <div class="flex items-center justify-between text-xs py-2 border-b border-dashed border-slate-100 cursor-pointer hover:bg-slate-50 px-2 rounded" onclick="${drill&&!drillCat?`drillCat='${e[0]}';loadMonthData()`:''}">
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="size-2.5 rounded-full shrink-0" style="background:${PALETTE[i%PALETTE.length]}"></span>
                                <span class="text-slate-600 font-bold truncate">${e[0]}</span>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <span class="text-slate-400 text-[10px]">${pct}%</span>
                                <span class="font-bold text-slate-800">$${fmt(e[1])}</span>
                            </div>
                        </div>`; 
                });
            }
        }

        function resetCharts() { drillCat=null; loadMonthData(); }

        // --- FORM & UI LOGIC ---
        function nav(v, el) { 
            document.querySelectorAll('.view-container').forEach(e=>e.classList.add('hidden-view')); 
            document.getElementById(`view-${v}`).classList.remove('hidden-view'); 
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active-tab', 'text-primary');
                b.classList.add('text-slate-400');
            });
            if(el) {
                el.classList.add('active-tab', 'text-primary');
                el.classList.remove('text-slate-400');
            }
        }

        function openModal(){ editId=null; resetForm(); setType('exp'); document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex'); }
        function closeModal(){ document.getElementById('modalOverlay').classList.add('hidden'); document.getElementById('modalOverlay').classList.remove('flex'); }
        
        function setType(t){
            document.getElementById('fType').value=t;
            const btnExp = document.getElementById('btnExp'); const btnInc = document.getElementById('btnInc');
            if(t === 'exp') {
                btnExp.className = "py-2.5 rounded-xl text-xs font-bold transition-all shadow-sm bg-white text-expense border border-slate-100 flex-1";
                btnInc.className = "py-2.5 rounded-xl text-xs font-bold transition-all text-slate-400 hover:text-slate-600 flex-1";
                document.getElementById('linkRow').classList.remove('hidden');
                renderChips('exp'); renderLinkChips();
                document.getElementById('lblDesc').innerText = "Concepto"; 
            } else {
                btnInc.className = "py-2.5 rounded-xl text-xs font-bold transition-all shadow-sm bg-white text-income border border-slate-100 flex-1";
                btnExp.className = "py-2.5 rounded-xl text-xs font-bold transition-all text-slate-400 hover:text-slate-600 flex-1";
                document.getElementById('linkRow').classList.add('hidden');
                renderChips('inc'); 
                document.getElementById('lblDesc').innerText = "Detalle";
            }
            document.getElementById('fCat').value = ''; document.getElementById('conceptBox').innerHTML = '';
        }

        function renderChips(type) {
            const container = document.getElementById('chipBox'); container.innerHTML = '';
            const cats = type === 'inc' ? (appData.cats.inc || []) : (appData.cats.exp || []);
            cats.forEach(c => {
                const chip = document.createElement('div');
                chip.className = `chip cursor-pointer select-none ${document.getElementById('fCat').value === c ? 'active' : ''}`;
                chip.innerText = c;
                chip.onclick = () => {
                    document.getElementById('fCat').value = c;
                    renderChips(type); // Re-render to update active class
                    renderConcepts(c);
                };
                container.appendChild(chip);
            });
        }
        
        function renderConcepts(catKey) {
            const box = document.getElementById('conceptBox'); box.innerHTML = '';
            const list = appData.concepts[catKey] || [];
            list.forEach(c => {
                const el = document.createElement('div'); el.className = 'chip bg-slate-50 border-transparent hover:bg-slate-100 cursor-pointer'; el.innerText = c;
                el.onclick = () => { document.getElementById('fDesc').value = c; };
                box.appendChild(el);
            });
        }

        function renderLinkChips(selectedId){
            const container = document.getElementById('linkChipsContainer'); container.innerHTML = '';
            const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
            const incs = appData.txs.filter(t=>!t.deletedAt && t.type=='inc' && parseInt(t.date.split('-')[1])==m);
            if(incs.length === 0) { container.innerHTML = '<span class="text-[10px] text-slate-400 italic">No hay ingresos disponibles</span>'; return; }
            incs.forEach(i => {
                const sp=appData.txs.filter(x=>!x.deletedAt && x.type=='exp' && x.linkId==i.id && x.id!=editId).reduce((a,b)=>a+b.amount,0);
                const bal = i.amount - sp;
                if(bal < 1 && i.id != selectedId) return; 
                const chip = document.createElement('div');
                chip.className = `chip cursor-pointer select-none ${selectedId == i.id ? 'active' : ''}`;
                chip.innerHTML = `<b>${i.desc}</b> <span class="opacity-70">($${fmt(bal)})</span>`;
                chip.onclick = () => {
                    document.getElementById('fLink').value = i.id;
                    renderLinkChips(i.id);
                };
                container.appendChild(chip);
            });
        }

        function calcConversion() {
            const amt = parseFloat(document.getElementById('fAmt').value) || 0;
            const curr = document.getElementById('fCurr').value;
            const rateARS = parseFloat(document.getElementById('rate_ARS').value) || 1200;
            let final = amt;
            if (curr === 'USD') final = amt * rateARS;
            if (curr === 'COP') final = (amt / parseFloat(document.getElementById('rate_COP').value)) * rateARS;
            document.getElementById('convResult').innerText = `$${fmt(final)} ARS`;
            document.getElementById('convPreview').classList.toggle('hidden', curr === 'ARS');
            return final;
        }

        document.getElementById('txForm').onsubmit=e=>{
            e.preventDefault();
            let cat=document.getElementById('fCat').value;
            const type = document.getElementById('fType').value;
            if(!cat) return alert('Selecciona categoría');
            const desc=document.getElementById('fDesc').value;
            if(cat) { if(!appData.concepts[cat]) appData.concepts[cat] = []; if(!appData.concepts[cat].includes(desc)) appData.concepts[cat].push(desc); }
            
            const tx={
                id:editId||Date.now(), date:document.getElementById('fDate').value,
                amount: calcConversion(), 
                origAmt: parseFloat(document.getElementById('fAmt').value), 
                origCurr: document.getElementById('fCurr').value,
                type, cat, desc, 
                exec:document.getElementById('fExec').checked,
                linkId:type=='exp'?document.getElementById('fLink').value:null, deletedAt:null
            };
            
            if(editId){ const i=appData.txs.findIndex(x=>x.id==editId); appData.txs[i]=tx; } else appData.txs.push(tx);
            saveData(); closeModal();
        }

        function editTx(id){const t=appData.txs.find(x=>x.id==id); if(!t)return; editId=id;document.getElementById('mTitle').innerText='Editar'; document.getElementById('btnDel').classList.remove('hidden');document.getElementById('fDate').value=t.date; document.getElementById('fDesc').value=t.desc; document.getElementById('fExec').checked=t.exec;document.getElementById('fAmt').value = t.origAmt || t.amount; document.getElementById('fCurr').value = t.origCurr || 'ARS';setType(t.type); setTimeout(() => {document.getElementById('fCat').value = t.cat;renderChips(t.type); if(t.type === 'exp') { document.getElementById('fLink').value = t.linkId || ""; renderLinkChips(t.linkId);}renderConcepts(t.cat);}, 50);calcConversion();document.getElementById('modalOverlay').classList.remove('hidden'); document.getElementById('modalOverlay').classList.add('flex');}
        function resetForm(){ document.getElementById('txForm').reset(); document.getElementById('mTitle').innerText='Nuevo'; document.getElementById('btnDel').classList.add('hidden'); document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; document.getElementById('convPreview').classList.add('hidden'); editId=null; }
        function delTx(){ if(confirm('Eliminar?')){ appData.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeModal(); }}
        
        function manualAddCat() { const n = document.getElementById('newCatName').value.trim(); const t = document.getElementById('newCatType').value; if(!n) return alert('Nombre?'); if(t === 'exp') { if(!appData.cats.exp.includes(n)) appData.cats.exp.push(n); } else { if(!appData.cats.inc.includes(n)) appData.cats.inc.push(n); } if(!appData.concepts[n]) appData.concepts[n] = []; document.getElementById('newCatName').value = ''; saveData(); }
        function manualAddConcept(catName) { const input = document.getElementById(`newCon_${catName}`); const val = input.value.trim(); if(!val) return; if(!appData.concepts[catName]) appData.concepts[catName] = []; if(!appData.concepts[catName].includes(val)) appData.concepts[catName].push(val); saveData(); }
        function delCat(type, name) { if(confirm(`¿Eliminar ${name}?`)) { if(type === 'exp') appData.cats.exp = appData.cats.exp.filter(x => x !== name); else appData.cats.inc = appData.cats.inc.filter(x => x !== name); delete appData.concepts[name]; saveData(); } }
        function delConcept(cat, name) { if(confirm(`¿Eliminar ${name}?`)) { appData.concepts[cat] = appData.concepts[cat].filter(x => x !== name); saveData(); } }
        function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
        function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
        function updateDateUI(){ document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
        function saveMonthlyRates() { const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1; appData.monthlyRates[`${y}-${m.toString().padStart(2,'0')}`] = { ARS: parseFloat(document.getElementById('rate_ARS').value), COP: parseFloat(document.getElementById('rate_COP').value), USD: 1 }; saveData(); }
        function renderRecurrentesAdmin() { const b=document.getElementById('recurrente-table-body'); b.innerHTML=''; appData.recurrentes.forEach((r,i)=>{const d=document.createElement('div'); d.className='flex gap-2 items-center text-xs border-b border-slate-100 py-2'; d.innerHTML=`<input value="${r.desc}" onchange="appData.recurrentes[${i}].desc=this.value" class="w-1/3 bg-slate-50 border-none rounded p-1"><input type="number" value="${r.amount}" onchange="appData.recurrentes[${i}].amount=parseFloat(this.value)" class="w-1/4 bg-slate-50 border-none rounded p-1 text-right"><span class="text-slate-400 text-[10px] w-1/4">${r.cat}</span><button onclick="appData.recurrentes.splice(${i},1);renderRecurrentesAdmin()" class="text-red-400 font-bold px-2">x</button>`; b.appendChild(d);}); }
        function addRecurrenteRow() { appData.recurrentes.push({desc:'Nuevo', amount:0, cat:'Esenciales', type:'exp'}); renderRecurrentesAdmin(); }
        function saveRecurrentesConfig() { saveData(); alert('Guardado'); }
        function executeRecurrentes() { const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; let c=0; appData.recurrentes.forEach(r=>{ if(!appData.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){ appData.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, origCurr:'ARS'}); c++; }}); if(c>0){saveData(); alert('Generados: '+c);} else alert('Ya estaban cargados'); }
        function clearMonth(){ if(confirm('Borrar MES actual?')){ const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; appData.txs.forEach(t=>{if(parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m) t.deletedAt=Date.now();}); saveData(); }}
        function renderAdminTree() {
            const container = document.getElementById('adminTreeContainer'); container.innerHTML = '';
            const buildBranch = (title, type) => {
                const cats = type === 'inc' ? appData.cats.inc : appData.cats.exp;
                const icon = type === 'inc' ? 'trending_up' : 'trending_down';
                const color = type === 'inc' ? 'text-income' : 'text-expense';
                let html = `<div class="mb-3"><div class="flex items-center gap-2 mb-2 px-1"><span class="material-symbols-outlined text-sm ${color}">${icon}</span><h4 class="font-bold text-[10px] text-slate-500 uppercase tracking-wide">${title}</h4></div><div class="space-y-1">`;
                cats.forEach(c => {
                    const concepts = appData.concepts[c] || [];
                    html += `<details class="group bg-slate-50 rounded-lg border border-slate-100 overflow-hidden open:bg-white open:shadow-sm transition-all"><summary class="flex justify-between items-center p-2 cursor-pointer hover:bg-slate-100 transition-colors"><div class="flex items-center gap-2"><span class="material-symbols-outlined text-slate-400 text-base group-open:text-primary transition-colors">folder</span><span class="text-[11px] font-bold text-slate-700">${c}</span><span class="text-[9px] text-slate-400 bg-white px-1.5 rounded-full border border-slate-100">${concepts.length}</span></div><button onclick="delCat('${type}','${c}')" class="text-slate-300 hover:text-red-500 transition-colors"><span class="material-symbols-outlined text-sm">delete</span></button></summary><div class="p-2 pt-0 border-t border-slate-100 bg-white"><div class="flex flex-wrap gap-1.5 mb-2 mt-2">${concepts.map(con => `<div class="chip flex items-center gap-1 group/tag py-0.5 px-2 bg-slate-50 border-none text-[10px]">${con}<button onclick="delConcept('${c}','${con}')" class="text-slate-300 hover:text-red-500 hidden group-hover/tag:block"><span class="material-symbols-outlined text-[10px] font-bold">close</span></button></div>`).join('')}</div><div class="flex gap-1"><input type="text" id="newCon_${c}" placeholder="+ Sub" class="w-full text-[10px] border-none bg-slate-50 rounded px-2 py-1 focus:ring-1 focus:ring-primary"><button onclick="manualAddConcept('${c}')" class="text-primary hover:bg-primary/10 rounded px-1"><span class="material-symbols-outlined text-sm">add</span></button></div></div></details>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            };
            buildBranch("Gastos", "exp");
            buildBranch("Ingresos", "inc");
        }
    </script>
</body>
</html>
