<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Finanzas</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAAnFBMVEUAABAAAAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AAAA/wD/AABF760yAAAAMXRSTlMAVt//H/D/7///2f////////8Q////////////////////8A/w8N3d3c7Ozs7AwMDAwG0sVpQAAASISURBOwV42u3c6XKjMBAFYG4D5r4SYwO+/2s2CWdJStK10nT6ovnHeKxPlkaC3S4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAALhOV5dX1ze39w/3j8+vb++fri9X03Guveq0Xk3H1w/3nz9//vzn188f9w/X03quveo0Xa9PH+8/f/5P//z74+N6PddemabrS/tf/uVf7y/X2ivTdH3/T/7j9eXaK9N0/fHvf72+Xntlmr7/X//x+nrtrb/VdC29M03X0jvT9P/SO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb2z/9F0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb0zTdfSO9N0Lb3zX03X9eX9L//yr/eXa+2Vabr+/Pn/T//8++Pjej3XXpmma+nV9eX9w/3jz//pn3//+vnj/uF6Wtfz3Hulq8ur65vb+4f7x+fXt/dP15er6TjXXgEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPgX/wF82G204h/W8QAAAABJRU5ErkJggg==">
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --bg: #F8FAFC; --surface: #FFFFFF; --txt: #1E293B; --txt-sec: #64748B; 
            --primary: #0F172A; --accent: #3B82F6; --inc: #10B981; --exp: #EF4444; 
            --border: #E2E8F0; --glass: rgba(255, 255, 255, 0.95);
            --safe-top: env(safe-area-inset-top);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); margin: 0; color: var(--txt); height: 100vh; overflow: hidden; user-select: none; display: flex; flex-direction: column; }

        /* HEADER */
        .header { 
            padding-top: calc(10px + var(--safe-top)); 
            padding-bottom: 10px;
            padding-left: 15px; padding-right: 15px;
            background: var(--glass); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 50; 
        }
        .brand { font-weight: 800; font-size: 15px; letter-spacing: -0.5px; display:flex; gap:6px; align-items:center; color: var(--primary); }
        .sync-dot { width:6px; height:6px; border-radius:50%; background:#CBD5E1; transition:0.3s; box-shadow: 0 0 0 2px white; }
        .date-pill { background: rgba(0,0,0,0.03); border-radius: 99px; padding: 4px 10px; display: flex; align-items: center; gap: 6px; font-weight: 700; font-size: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .btn-arrow { background: none; border: none; font-size: 12px; color: var(--txt); cursor: pointer; padding: 4px; opacity: 0.6; }

        /* LAYOUT */
        .main-container { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .view-section { display: none; height: 100%; flex-direction: column; } 
        .view-section.active { display: flex; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD */
        .dash-content { padding: 8px 10px; display: flex; flex-direction: column; height: 100%; gap: 8px; }
        .kpi-hero { background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); padding: 12px; border-radius: 14px; color: white; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); flex-shrink: 0; }
        .hero-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .hero-bal { font-size: 22px; font-weight: 800; line-height: 1; transition: color 0.3s; }
        .hero-usd { font-size: 10px; opacity: 0.9; font-weight: 600; margin-left: 5px; transition: color 0.3s; }
        .tc-widget { background: rgba(255,255,255,0.1); padding: 1px 6px; border-radius: 4px; font-size: 9px; display: flex; align-items: center; gap: 3px; font-weight: 600; margin-bottom: 2px; }
        .tc-inp { background: transparent; border: none; color: white; font-weight: 700; width: 30px; text-align: right; font-size: 9px; border-bottom: 1px solid rgba(255,255,255,0.3); padding: 0; }
        .hero-stats { display: flex; gap: 10px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-item { flex: 1; display:flex; justify-content: space-between; align-items: center; }
        .stat-lbl { font-size: 8px; opacity: 0.6; font-weight: 600; }
        .stat-val { font-size: 11px; font-weight: 700; }

        /* TABS */
        .tabs-pill { display: flex; background: #E2E8F0; padding: 2px; border-radius: 8px; flex-shrink: 0; }
        .tab-btn { flex: 1; text-align: center; padding: 5px; border-radius: 6px; font-size: 10px; font-weight: 700; color: var(--txt-sec); cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        /* LISTAS */
        .grid-lists { display: flex; gap: 8px; flex: 1; min-height: 0; width: 100%; overflow: hidden; }
        .list-col { flex: 1; background: var(--surface); border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
        .col-head { padding: 6px; text-align: center; font-size: 9px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .bg-inc { background: var(--inc); justify-content: center; } 
        .bg-exp { background: var(--exp); }
        .list-scroll { flex: 1; overflow-y: auto; padding: 0; -webkit-overflow-scrolling: touch; }
        
        .search-container { display:flex; align-items:center; background:#FEF2F2; padding-right:5px; border-bottom:1px solid #fecaca; }
        .search-inp { width:100%; border:none; padding:6px; font-size:9px; background:transparent; }
        .btn-clear { background:none; border:none; font-size:10px; color:#EF4444; cursor:pointer; padding:0 5px; }

        /* TARJETA MOVIMIENTO */
        .tx-card { background: white; padding: 8px 10px; border-bottom: 1px solid #F1F5F9; cursor: pointer; }
        .tx-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .tx-desc { font-weight: 700; font-size: 11px; color: var(--txt); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px; letter-spacing: -0.2px; }
        .tx-amt { font-weight: 800; font-size: 11px; }
        .tx-sub { display: flex; justify-content: space-between; font-size: 9px; color: var(--txt-sec); align-items: center; margin-top: 1px; }
        
        .cat-tag { background: #F1F5F9; padding: 0px 4px; border-radius: 3px; font-size: 8px; font-weight: 600; color: var(--txt-sec); }
        .source-tag { background: #DBEAFE; color: #1E40AF; padding: 0px 5px; border-radius: 3px; font-size: 9px; font-weight: 800; display: flex; align-items: center; gap: 3px; margin-right: 4px; }
        
        .magic-q { font-size: 9px; font-weight: 700; margin-left: 4px; }
        .q-ok { color: var(--inc); } .q-bad { color: var(--exp); }

        .executed { opacity: 0.5; }
        .executed .tx-desc, .executed .tx-amt { text-decoration: line-through; color: var(--txt-sec) !important; }

        /* ALLOCATION VIEW */
        .alloc-container { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .alloc-card { background: white; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 8px; overflow: hidden; }
        .alloc-head { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .alloc-prog { height: 4px; width: 100%; background: #E2E8F0; }
        .alloc-fill { height: 100%; background: var(--inc); }
        .alloc-children { background: #F8FAFC; display: none; border-top: 1px solid var(--border); }
        .child-row { padding: 6px 10px; display: flex; justify-content: space-between; font-size: 10px; color: var(--txt); border-bottom: 1px solid rgba(0,0,0,0.03); }
        .child-row.executed span { text-decoration: line-through; opacity: 0.6; }
        
        .search-alloc-wrap { display:flex; align-items:center; background:#F1F5F9; border:1px solid var(--border); border-radius:8px; margin-bottom:10px; padding-right:8px; }
        .search-alloc { width:100%; padding:8px; border:none; background:transparent; font-size:11px; }

        /* CHARTS */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
        .chart-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; }
        .chart-header { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--txt-sec); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .chart-body { display: flex; align-items: center; gap: 10px; height: 160px; }
        .chart-line-body { height: 160px; width: 100%; position: relative; }
        .donut-container { width: 120px; height: 120px; flex-shrink: 0; position: relative; }
        .legend-container { flex: 1; height: 100%; overflow-y: auto; padding-right: 2px; }
        .legend-item { display: flex; align-items: center; justify-content: space-between; font-size: 9px; padding: 5px 0; border-bottom: 1px dashed #F1F5F9; cursor: pointer; }
        .legend-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 5px; flex-shrink: 0; }
        .legend-name { color: var(--txt); font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* NAV & SHEET */
        .bottom-nav { height: 60px; background: var(--glass); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; padding-bottom: 5px; }
        .nav-btn { font-size: 18px; color: #CBD5E1; background: none; border: none; padding: 6px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn span { font-size: 9px; font-weight: 700; }
        .nav-btn.active { color: var(--primary); }
        .fab { width: 48px; height: 48px; background: var(--primary); border-radius: 16px; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; transform: translateY(-15px); border: 4px solid var(--bg); box-shadow: 0 6px 15px rgba(15,23,42,0.3); }

        .sheet, .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: 0.2s; display: flex; align-items: flex-end; backdrop-filter: blur(2px); }
        .sheet.open, .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .sheet-box { background: var(--surface); width: 100%; border-radius: 16px 16px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .sheet.open .sheet-box { transform: translateY(0); }
        .modal-center { background: white; width: 85%; margin: auto; border-radius: 16px; padding: 20px; transform: scale(0.9); transition: 0.2s; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-overlay.open .modal-center { transform: scale(1); }

        /* FORM */
        .big-inp { width: 100%; border: none; background: #F1F5F9; border-radius: 10px; font-size: 20px; font-weight: 800; padding: 12px; color: var(--txt); text-align: right; margin-bottom: 8px; }
        .chip-container { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 12px; scrollbar-width: none; }
        .chip { padding: 5px 10px; border-radius: 6px; background: white; border: 1px solid var(--border); color: var(--txt-sec); font-weight: 600; font-size: 10px; white-space: nowrap; transition: 0.1s; }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .inp-lbl { font-size: 9px; font-weight: 800; color: var(--txt-sec); text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        /* SETTINGS */
        .settings-group { margin-bottom: 20px; }
        .tree-node { margin-bottom: 6px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: white; }
        .tree-head { padding: 6px 10px; background: #F8FAFC; display: flex; justify-content: space-between; align-items: center; font-size: 10px; font-weight: 700; cursor: pointer; }
        .tree-body { padding: 6px; display: none; flex-wrap: wrap; gap: 4px; border-top: 1px solid var(--border); }
        .concept-tag { font-size: 9px; padding: 2px 6px; background: #F1F5F9; border-radius: 4px; border: 1px solid transparent; display: flex; align-items: center; gap: 3px; }

        .loader { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:200; display:none; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="loader" class="loader"><i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary)"></i></div>

<div class="header">
    <div class="brand">Flow <div id="syncDot" class="sync-dot"></div></div>
    <div class="date-pill" onclick="changeMonth(0)"> 
        <button class="btn-arrow" onclick="event.stopPropagation(); changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="date-txt" id="monthTxt">...</div>
        <button class="btn-arrow" onclick="event.stopPropagation(); changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div style="width:20px;"></div>
</div>

<div class="main-container">

    <div id="view-home" class="view-section active">
        <div class="dash-content">
            <div class="kpi-hero">
                <div class="hero-top">
                    <div>
                        <div class="hero-bal" id="kpiBal">$0</div>
                        <div class="hero-usd">≈ USD <span id="kpiUsd">0</span></div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:flex-end;">
                        <div class="tc-widget">1 USD = <input type="number" id="rateArs" value="1200" class="tc-inp" onchange="saveRates()"> ARS</div>
                        <div class="tc-widget">1 USD = <input type="number" id="rateCop" value="3700" class="tc-inp" onchange="saveRates()"> COP</div>
                    </div>
                </div>
                <div class="hero-stats">
                    <div class="stat-item"><span class="stat-lbl">INGRESOS</span><span class="stat-val" style="color:#34D399" id="sum-inc">$0</span></div>
                    <div class="stat-item" style="justify-content:flex-end; gap:8px;"><span class="stat-lbl">GASTOS</span><span class="stat-val" style="color:#F87171" id="sum-exp">$0</span></div>
                </div>
            </div>

            <div class="tabs-pill">
                <div class="tab-btn active" id="tab-txs" onclick="setSubTab('txs')">Movimientos</div>
                <div class="tab-btn" id="tab-alloc" onclick="setSubTab('alloc')">Asignación</div>
            </div>

            <div id="sec-txs" class="grid-lists">
                <div class="list-col">
                    <div class="col-head bg-inc">Ingresos</div>
                    <div id="list-inc" class="list-scroll"></div>
                </div>
                <div class="list-col">
                    <div class="col-head bg-exp">
                        <span>Egresos</span>
                        <i class="fas fa-search" style="opacity:0.7; font-size:9px;" onclick="document.getElementById('searchBar').classList.toggle('hidden')"></i>
                    </div>
                    <div id="searchContainerExp" class="search-container hidden">
                        <input type="text" id="searchBar" placeholder="Buscar..." class="search-inp" oninput="filterExp()">
                        <button class="btn-clear" onclick="clearSearch('exp')"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="list-exp" class="list-scroll"></div>
                </div>
            </div>

            <div id="sec-alloc" style="display:none;" class="alloc-container">
                <div class="search-alloc-wrap">
                    <input type="text" id="allocSearch" class="search-alloc" placeholder="Buscar gasto asignado..." oninput="renderAlloc()">
                    <button class="btn-clear" onclick="clearSearch('alloc')"><i class="fas fa-times"></i></button>
                </div>
                <div id="alloc-list"></div>
            </div>
        </div>
    </div>

    <div id="view-stats" class="view-section" style="padding:10px; overflow-y:auto;">
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <span id="titleExp">Gastos por Categoría</span>
                    <button onclick="resetChart('exp')" id="resetExp" style="border:none; background:none; color:var(--accent); font-size:9px; display:none;">VOLVER</button>
                </div>
                <div class="chart-body">
                    <div class="donut-container"><canvas id="chartExp"></canvas></div>
                    <div class="legend-container" id="legExp"></div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span id="titleInc">Ingresos por Categoría</span>
                    <button onclick="resetChart('inc')" id="resetInc" style="border:none; background:none; color:var(--accent); font-size:9px; display:none;">VOLVER</button>
                </div>
                <div class="chart-body">
                    <div class="donut-container"><canvas id="chartInc"></canvas></div>
                    <div class="legend-container" id="legInc"></div>
                </div>
            </div>
        </div>
        <div class="chart-card" style="margin-top:10px;">
            <div class="chart-header"><span>Evolución de Saldo</span></div>
            <div class="chart-line-body">
                <canvas id="chartBal"></canvas>
            </div>
        </div>
    </div>

    <div id="view-settings" class="view-section" style="padding:15px; overflow-y:auto;">
        <div class="settings-group">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span class="inp-lbl">Gastos Recurrentes</span>
                <span style="color:var(--accent); font-size:10px; font-weight:700; cursor:pointer;" onclick="addRecurrenteUI()">+ Agregar</span>
            </div>
            <div id="list-recurrentes" style="background:white; border-radius:10px; padding:8px; margin-bottom:8px; max-height:150px; overflow-y:auto; border:1px solid var(--border);"></div>
            <button onclick="populateRecurringDefaults()" style="width:100%; padding:8px; background:white; border:1px solid var(--border); border-radius:8px; font-size:9px; font-weight:700; color:var(--txt-sec);">Analizar Historial (3M)</button>
        </div>
        
        <div class="settings-group">
            <div class="inp-lbl">Categorías</div>
            <div id="admin-tree"></div>
        </div>

        <div class="settings-group">
            <div class="inp-lbl">Herramientas</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <button onclick="executeRecurrentes()" style="padding:10px; background:white; border:1px solid var(--border); border-radius:8px; font-size:9px; font-weight:700;">Ejecutar Recurrentes</button>
                <button onclick="openCloneModal()" style="padding:10px; background:white; border:1px solid var(--border); border-radius:8px; font-size:9px; font-weight:700;">Clonar Mes...</button>
                <button onclick="forceSync()" style="grid-column:span 2; padding:10px; background:white; border:1px solid var(--border); border-radius:8px; font-size:10px; font-weight:700; color:var(--primary);">Sincronizar Nube</button>
                <button onclick="clearMonth()" style="grid-column:span 2; padding:10px; background:#FEF2F2; border:1px solid #FECACA; border-radius:8px; font-size:9px; font-weight:700; color:#EF4444;">Borrar Todo el Mes</button>
            </div>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <button class="nav-btn active" id="nav-home" onclick="nav('home')"><i class="fas fa-wallet"></i><span>Home</span></button>
    <div class="fab" onclick="openNewTx()"><i class="fas fa-plus"></i></div>
    <button class="nav-btn" id="nav-stats" onclick="nav('stats')"><i class="fas fa-chart-pie"></i><span>Stats</span></button>
    <button class="nav-btn" id="nav-settings" onclick="nav('settings')"><i class="fas fa-cog"></i><span>Ajustes</span></button>
</div>

<div class="sheet" id="sheet" onclick="if(event.target===this) closeSheet()">
    <div class="sheet-box">
        <form id="txForm">
            <div style="display:flex; gap:10px;">
                <input type="number" id="fAmount" class="big-inp" placeholder="0" step="0.01" required>
                <select id="fCurr" style="width:70px; margin-bottom:8px; background:#E2E8F0; border:none; border-radius:10px; font-weight:700; text-align:center; font-size:12px;">
                    <option value="ARS">ARS</option>
                    <option value="USD">USD</option>
                    <option value="COP">COP</option>
                </select>
            </div>
            <div class="tabs-pill" style="margin-bottom:12px;">
                <div class="tab-btn active" id="seg-exp" onclick="setType('exp')">Gasto</div>
                <div class="tab-btn" id="seg-inc" onclick="setType('inc')">Ingreso</div>
            </div>
            <input type="hidden" id="fType" value="exp">

            <div style="margin-bottom:12px;">
                <span class="inp-lbl">CATEGORÍA</span>
                <div class="chip-container" id="catChips"></div>
                <input type="hidden" id="fCat">
            </div>

            <div style="margin-bottom:12px;">
                <span class="inp-lbl">CONCEPTO</span>
                <div class="chip-container" id="conChips"></div>
                <input type="text" id="fCustomDesc" class="big-inp" style="font-size:14px; text-align:left; display:none; background:white; border:1px solid var(--border);" placeholder="Nombre...">
                <input type="hidden" id="fConcept">
            </div>

            <div id="linkSection" style="margin-bottom:12px;">
                <span class="inp-lbl" style="color:var(--accent);">VINCULAR A INGRESO</span>
                <div class="chip-container" id="linkChips"></div>
                <input type="hidden" id="fLink">
            </div>

            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                <div style="flex:1;">
                    <span class="inp-lbl">FECHA</span>
                    <input type="date" id="fDate" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; background:#F8FAFC; font-size:12px;" required>
                </div>
                <div style="width:90px; display:flex; flex-direction:column; justify-content:flex-end;">
                     <div style="display:flex; align-items:center; gap:6px; padding:10px; background:#F8FAFC; border:1px solid var(--border); border-radius:8px; height:37px;">
                        <input type="checkbox" id="fExec" checked style="margin:0;"> 
                        <span style="font-size:10px; font-weight:700;">Ejecutado</span>
                    </div>
                </div>
            </div>

            <button type="submit" style="width:100%; padding:14px; background:var(--primary); color:white; font-weight:800; border-radius:10px; border:none; margin-bottom:8px;">GUARDAR</button>
            <button type="button" id="btnDel" onclick="delTx()" style="width:100%; color:#EF4444; background:none; border:none; font-weight:700; font-size:12px; display:none;">Eliminar</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="modalClone">
    <div class="modal-center">
        <h3 style="margin-top:0; margin-bottom:10px;">Clonar Mes</h3>
        <p style="font-size:11px; color:#666; margin-bottom:15px;">Selecciona el mes origen para copiar sus movimientos a este mes.</p>
        <select id="selCloneSrc" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ccc; border-radius:8px;"></select>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('modalClone').classList.remove('open')" style="flex:1; padding:10px; border:none; background:#eee; border-radius:8px; font-weight:700;">Cancelar</button>
            <button onclick="doCloneMonth()" style="flex:1; padding:10px; border:none; background:var(--primary); color:white; border-radius:8px; font-weight:700;">Clonar</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    const MONTHS = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];
    const PALETTE = ['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#64748B','#EC4899','#14B8A6'];

    let data = { txs: [], cats: { exp:['Esenciales','Varios'], inc:['Sueldo'] }, concepts: {}, recurrentes: [], monthlyRates: {} };
    let currentTxs = [], editId = null;
    let drillCatExp = null, drillCatInc = null;
    let tempCat='', tempLink='';
    let currentDate = new Date(); currentDate.setDate(1);

    const fmt = (n) => n.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0});

    window.onload = () => { updateDateUI(); forceSync(); };

    function updateDateUI() { 
        document.getElementById('monthTxt').innerText = `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; 
        loadData(); 
    }
    function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); updateDateUI(); }
    
    function saveRates() {
        const key = getKey();
        if(!data.monthlyRates) data.monthlyRates={};
        data.monthlyRates[key] = { ARS: parseFloat(document.getElementById('rateArs').value)||1200, COP: parseFloat(document.getElementById('rateCop').value)||3700 };
        saveData();
    }
    function getKey() { return `${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }

    function loadData() {
        const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
        const key = getKey();
        let rates = (data.monthlyRates && data.monthlyRates[key]) ? data.monthlyRates[key] : { ARS: 1200, COP: 3700 };
        document.getElementById('rateArs').value = rates.ARS; document.getElementById('rateCop').value = rates.COP;
        currentTxs = (data.txs || []).filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
        
        currentTxs.forEach(t => {
            if(!t.exec) {
                if(t.curr === 'USD') t.amount = t.origAmt * rates.ARS;
                if(t.curr === 'COP') t.amount = (t.origAmt / rates.COP) * rates.ARS; 
            }
        });

        // Ordenamos para que el calculo de acumulado sea correcto
        currentTxs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
        
        renderDash(); renderAlloc();
        if(document.getElementById('view-stats').classList.contains('active')) renderStats();
        if(document.getElementById('view-settings').classList.contains('active')) renderSettings();
    }

    function renderDash() {
        const inc = currentTxs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
        const exp = currentTxs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
        const bal = inc - exp;
        const rateArs = parseFloat(document.getElementById('rateArs').value)||1;
        
        const balEl = document.getElementById('kpiBal');
        const usdEl = document.getElementById('kpiUsd');
        const color = bal >= 0 ? '#34D399' : '#F87171';
        
        balEl.innerText = `AR$ ${fmt(bal)}`;
        balEl.style.color = color;
        
        usdEl.innerText = fmt(Math.round(bal/rateArs));
        usdEl.style.color = color;
        
        document.getElementById('sum-inc').innerText = `$${fmt(inc)}`;
        document.getElementById('sum-exp').innerText = `$${fmt(exp)}`;

        const lInc = document.getElementById('list-inc'), lExp = document.getElementById('list-exp');
        lInc.innerHTML = ''; lExp.innerHTML = '';

        // 1. CALCULAMOS SALDO ACUMULADO (GLOBAL RUNNING BALANCE)
        // Creamos un mapa de ID -> Saldo al momento de esa transaccion
        let runningBal = 0;
        const balMap = {};
        
        currentTxs.forEach(t => {
            if(t.type === 'inc') runningBal += t.amount;
            else runningBal -= t.amount;
            balMap[t.id] = runningBal; // Guardamos el saldo exacto en ese momento
        });

        currentTxs.forEach(t => {
            const isInc = t.type === 'inc';
            const el = document.createElement('div');
            el.className = `tx-card ${t.exec ? 'executed' : ''}`;
            el.onclick = () => edit(t.id);
            
            let extraInfo = '';
            if(t.curr && t.curr!=='ARS') extraInfo += `<span style="color:var(--accent); font-weight:800; margin-left:4px;">${t.origAmt} ${t.curr}</span>`;
            
            let sourceTag = '';
            let qMagic = '';

            // Renderizamos Etiqueta Azul si existe (sin afectar el calculo del SubT que ahora es global)
            if(!isInc && t.linkId) {
                const parentInc = currentTxs.find(x => x.id == t.linkId);
                if(parentInc) {
                    sourceTag = `<span class="source-tag"><i class="fas fa-link" style="font-size:8px;"></i> ${parentInc.desc}</span>`;
                }
            }

            // Usamos el Saldo Global calculado previamente
            const currentGlobalBal = balMap[t.id];
            // Solo mostramos SubT en Egresos para no saturar, o en ambos si prefieres. Lo dejare en egresos como pediste antes.
            if(!isInc) {
                qMagic = `<span class="magic-q ${currentGlobalBal>=0?'q-ok':'q-bad'}">SubT: $${fmt(currentGlobalBal)}</span>`;
            }

            const catDisplay = isInc ? `<span class="cat-tag">${t.cat}</span>` : '';

            el.innerHTML = `
                <div class="tx-top">
                    <div class="tx-desc">${t.desc}</div>
                    <div class="tx-amt" style="color:${isInc?'var(--inc)':'var(--txt)'}">$${fmt(t.amount)}</div>
                </div>
                <div class="tx-sub">
                    <div style="display:flex; align-items:center;">
                        ${sourceTag}
                        ${catDisplay} ${extraInfo} ${qMagic}
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span>${t.date.split('-')[2]}</span>
                        <i class="fas fa-copy" style="color:#cbd5e1; font-size:10px;" onclick="event.stopPropagation(); cloneTx('${t.id}')"></i>
                    </div>
                </div>
            `;
            (isInc ? lInc : lExp).appendChild(el);
        });
        filterExp();
    }
    
    function clearSearch(type) {
        if(type === 'exp') {
            document.getElementById('searchBar').value = '';
            filterExp();
        } else {
            document.getElementById('allocSearch').value = '';
            renderAlloc();
        }
    }

    function filterExp() {
        const term = document.getElementById('searchBar').value.toLowerCase();
        document.querySelectorAll('#list-exp .tx-card').forEach(r => r.style.display = r.innerText.toLowerCase().includes(term) ? 'block' : 'none');
    }

    function renderAlloc() {
        const c = document.getElementById('alloc-list'); c.innerHTML='';
        const term = document.getElementById('allocSearch').value.toLowerCase();

        const incs = currentTxs.filter(t=>t.type=='inc');
        const exps = currentTxs.filter(t=>t.type=='exp');

        incs.forEach(inc => {
            const subs = exps.filter(e => e.linkId == inc.id);
            const spent = subs.reduce((a,b)=>a+b.amount,0);
            const remaining = inc.amount - spent;
            const pctLeft = Math.max(0, 100 - (inc.amount > 0 ? (spent/inc.amount)*100 : 0));
            const color = remaining >= 0 ? 'var(--inc)' : 'var(--exp)';

            const filteredSubs = term ? subs.filter(s => s.desc.toLowerCase().includes(term)) : subs;
            
            if(term && filteredSubs.length === 0 && !inc.desc.toLowerCase().includes(term)) return;

            const card = document.createElement('div'); card.className='alloc-card';
            let childHTML = '';
            
            (term ? filteredSubs : subs).forEach(s => {
                childHTML += `<div class="child-row ${s.exec?'executed':''}"><span>${s.desc}</span><span>$${fmt(s.amount)}</span></div>`;
            });

            if(!subs.length) childHTML = '<div class="child-row" style="font-style:italic; color:#cbd5e1;">Sin gastos</div>';
            else if(term && filteredSubs.length === 0) childHTML = '<div class="child-row" style="font-style:italic; color:#cbd5e1;">Sin coincidencias</div>';

            const displayStyle = term ? 'block' : 'none';

            card.innerHTML = `
                <div class="alloc-head" onclick="this.parentElement.querySelector('.alloc-children').style.display = this.parentElement.querySelector('.alloc-children').style.display=='block'?'none':'block'">
                    <div><div style="font-weight:700; font-size:11px;">${inc.desc}</div><div style="font-size:9px; color:var(--txt-sec);">Ingreso: $${fmt(inc.amount)}</div></div>
                    <div style="text-align:right;"><div style="font-weight:800; font-size:11px; color:${color}">$${fmt(remaining)}</div><div style="font-size:9px; color:var(--txt-sec);">Disponible</div></div>
                </div>
                <div class="alloc-prog"><div class="alloc-fill" style="width:${pctLeft}%; background:${color}"></div></div>
                <div class="alloc-children" style="display:${displayStyle}">${childHTML}</div>
            `;
            c.appendChild(card);
        });
        
        const orphans = exps.filter(e => !e.linkId);
        const orphansFiltered = term ? orphans.filter(e => e.desc.toLowerCase().includes(term)) : orphans;
        const orphansTotal = orphans.reduce((a,b)=>a+b.amount,0);

        if(orphans.length > 0 && (!term || orphansFiltered.length > 0)) {
             c.innerHTML += `<div class="alloc-card" style="border-left:4px solid var(--exp); padding:10px;"><div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700;"><span>Sin Asignar (${orphansFiltered.length})</span><span style="color:var(--exp);">$${fmt(orphansTotal)}</span></div></div>`;
        }
    }

    function renderStats() {
        renderSpecificChart('exp', drillCatExp, 'chartExp', 'legExp', 'resetExp', 'titleExp', 'Gastos por Categoría');
        renderSpecificChart('inc', drillCatInc, 'chartInc', 'legInc', 'resetInc', 'titleInc', 'Ingresos por Categoría');
        renderEvolutionChart();
    }

    function renderSpecificChart(type, drillCat, canvasId, legendId, resetBtnId, titleId, defaultTitle) {
        let txs = currentTxs.filter(t => t.type == type);
        let key = 'cat';

        if(drillCat) {
            document.getElementById(resetBtnId).style.display = 'block';
            document.getElementById(titleId).innerText = drillCat;
            txs = txs.filter(t => t.cat === drillCat);
            key = 'desc'; 
        } else {
            document.getElementById(resetBtnId).style.display = 'none';
            document.getElementById(titleId).innerText = defaultTitle;
        }

        renderDoughnut(document.getElementById(canvasId), document.getElementById(legendId), txs, key, type);
    }

    function renderDoughnut(cvs, leg, txs, key, type) {
        let map={};
        txs.forEach(t=>{ const k=t[key]||'Gral'; map[k]=(map[k]||0)+t.amount; });
        const ent = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const tot = ent.reduce((a,b)=>a+b[1],0);

        const chartInstance = Chart.getChart(cvs);
        if(chartInstance) chartInstance.destroy();

        new Chart(cvs, {
            type: 'doughnut',
            data: { labels: ent.map(e=>e[0]), datasets: [{ data: ent.map(e=>e[1]), backgroundColor: PALETTE, borderWidth:0 }] },
            options: { 
                responsive:true, 
                maintainAspectRatio:false, 
                cutout:'70%', 
                animation: { duration: 0 }, 
                plugins:{legend:{display:false}}, 
                onClick:(e,el)=>{
                    if(el.length > 0) {
                        const idx = el[0].index;
                        const selected = ent[idx][0];
                        if(type === 'exp' && !drillCatExp) { drillCatExp = selected; renderStats(); }
                        if(type === 'inc' && !drillCatInc) { drillCatInc = selected; renderStats(); }
                    }
                }
            } 
        });

        leg.innerHTML = '';
        ent.forEach((e,i) => {
            const pct = tot > 0 ? Math.round((e[1]/tot)*100) : 0;
            const item = document.createElement('div');
            item.className = 'legend-item';
            item.onclick = () => { 
                if(type === 'exp' && !drillCatExp) { drillCatExp = e[0]; renderStats(); }
                if(type === 'inc' && !drillCatInc) { drillCatInc = e[0]; renderStats(); }
            };
            
            item.innerHTML = `
                <div style="display:flex; align-items:center; flex:1; min-width:0;">
                    <div class="legend-dot" style="background:${PALETTE[i%PALETTE.length]}"></div>
                    <div class="legend-name">${e[0]}</div>
                </div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:8px; color:var(--txt-sec);">${pct}%</span>
                    <span style="font-weight:700; font-size:10px; color:var(--txt);">$${fmt(e[1])}</span>
                </div>
            `;
            leg.appendChild(item);
        });
    }

    function renderEvolutionChart() {
        const cvs = document.getElementById('chartBal');
        const chartInstance = Chart.getChart(cvs);
        if(chartInstance) chartInstance.destroy();

        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
        const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
        const dataPoints = [];
        let accum = 0;

        const flow = new Array(daysInMonth + 1).fill(0);
        currentTxs.forEach(t => {
            const d = parseInt(t.date.split('-')[2]);
            if(t.type === 'inc') flow[d] += t.amount;
            else flow[d] -= t.amount;
        });

        for(let i=1; i<=daysInMonth; i++) {
            accum += flow[i];
            dataPoints.push(accum);
        }

        new Chart(cvs, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Saldo Acumulado',
                    data: dataPoints,
                    borderColor: '#0F172A',
                    backgroundColor: 'rgba(15, 23, 42, 0.1)',
                    borderWidth: 2,
                    pointRadius: 1,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 9 } } },
                    y: { display: false }
                }
            }
        });
    }
    
    function resetChart(type) {
        if(type === 'exp') drillCatExp = null;
        if(type === 'inc') drillCatInc = null;
        renderStats();
    }

    function renderSettings() { renderRecurrentesList(); renderAdminTree(); }
    function renderRecurrentesList() {
        const c = document.getElementById('list-recurrentes'); c.innerHTML='';
        if(!data.recurrentes.length) { c.innerHTML='<div style="text-align:center; color:#cbd5e1; font-size:9px;">Sin datos</div>'; return; }
        data.recurrentes.forEach((r,i) => {
            const d=document.createElement('div'); d.className='tx-card'; // Reusar estilo card
            d.style.marginBottom='5px'; d.style.padding='15px'; // Area de toque aumentada
            d.innerHTML=`<div style="display:flex;justify-content:space-between;width:100%"><span>${r.desc}</span><div style="display:flex; gap:8px;"><b>$${fmt(r.amount)}</b><i class="fas fa-times" style="color:#ef4444;" onclick="event.stopPropagation(); data.recurrentes.splice(${i},1);saveData();renderSettings()"></i></div></div>`;
            d.onclick=()=>{ 
                 const newAmt = prompt('Nuevo monto:', r.amount);
                 if(newAmt) { data.recurrentes[i].amount = parseFloat(newAmt); saveData(); renderSettings(); }
            };
            c.appendChild(d);
        });
    }
    
    function addRecurrenteUI() {
        const desc = prompt("Nombre del gasto recurrente:");
        if(!desc) return;
        const amount = prompt("Monto estimado:");
        if(!amount) return;
        data.recurrentes.push({ desc: desc, amount: parseFloat(amount), cat: 'Esenciales', type: 'exp' });
        saveData();
        renderSettings();
    }

    function renderAdminTree() {
        const c = document.getElementById('admin-tree'); c.innerHTML='';
        [{k:'exp'},{k:'inc'}].forEach(type => {
            (data.cats[type.k]||[]).forEach(cat => {
                const node = document.createElement('div'); node.className='tree-node';
                const concepts = data.concepts[cat]||[];
                node.innerHTML = `
                    <div class="tree-head" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='flex'?'none':'flex'">
                        <span>${cat} <span style="font-weight:400; color:#94a3b8;">(${concepts.length})</span></span>
                        <i class="fas fa-trash" style="color:#cbd5e1; font-size:9px;" onclick="event.stopPropagation();delCat('${type.k}','${cat}')"></i>
                    </div>
                    <div class="tree-body">
                        ${concepts.map(con => `<div class="concept-tag">${con} <i class="fas fa-times" style="color:#cbd5e1; cursor:pointer;" onclick="delCon('${cat}','${con}')"></i></div>`).join('')}
                        <div class="concept-tag" style="background:white; border:1px dashed #cbd5e1; color:var(--accent); cursor:pointer;" onclick="addCon('${cat}')">+</div>
                    </div>
                `;
                c.appendChild(node);
            });
        });
    }

    function delCat(t,c){ if(confirm('Borrar?')) { data.cats[t]=data.cats[t].filter(x=>x!==c); delete data.concepts[c]; saveData(); renderSettings(); }}
    function delCon(c,n){ if(confirm('Borrar?')) { data.concepts[c]=data.concepts[c].filter(x=>x!==n); saveData(); renderSettings(); }}
    function addCon(c){ const n=prompt('Nueva:'); if(n){ if(!data.concepts[c])data.concepts[c]=[]; data.concepts[c].push(n); saveData(); renderSettings(); }}
    
    function executeRecurrentes() {
        const txt = document.getElementById('monthTxt').innerText;
        if(!confirm(`¿Ejecutar en ${txt}?`)) return;
        const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; let c=0;
        data.recurrentes.forEach(r=>{
            if(!data.txs.some(t=>!t.deletedAt && t.desc==r.desc && parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m)){
                 data.txs.push({...r, id:Date.now()+Math.random(), date:`${y}-${m.toString().padStart(2,'0')}-01`, exec:false, linkId:null, deletedAt:null, origAmt:r.amount, curr:'ARS'}); c++;
            }
        });
        alert(c>0 ? `Generados ${c}` : 'Ya estaban'); saveData();
    }
    function populateRecurringDefaults() {
        if(!confirm("¿Analizar 3 meses?")) return;
        const limit = new Date(); limit.setDate(limit.getDate() - 90);
        const recent = data.txs.filter(t => !t.deletedAt && t.type === 'exp' && new Date(t.date) >= limit);
        const analysis = {};
        recent.forEach(t => { 
            const d = t.desc.trim(); 
            if(!analysis[d]) analysis[d] = { count: 0, lastAmt: 0, cat: t.cat, dates: new Set() }; 
            analysis[d].count++; analysis[d].lastAmt = t.origAmt || t.amount; analysis[d].cat = t.cat; analysis[d].dates.add(t.date.substring(0, 7)); 
        });
        let added = 0;
        Object.entries(analysis).forEach(([desc, info]) => {
            const exists = data.recurrentes.some(r => r.desc.toLowerCase() === desc.toLowerCase());
            if((info.dates.size >= 2 || info.count >= 2) && !exists) { data.recurrentes.push({ desc: desc, amount: info.lastAmt, cat: info.cat, type: 'exp' }); added++; }
        });
        alert(`Agregadas ${added}`); saveData(); renderSettings();
    }

    function openNewTx() { editId=null; resetForm(); openSheet(); }
    function openSheet() { document.getElementById('sheet').classList.add('open'); }
    function closeSheet() { document.getElementById('sheet').classList.remove('open'); }
    function resetForm() {
        document.getElementById('txForm').reset(); document.getElementById('btnDel').style.display = 'none';
        const now = new Date(); const y=currentDate.getFullYear(), m=(currentDate.getMonth()+1).toString().padStart(2,'0');
        const d=(y==now.getFullYear() && (currentDate.getMonth())==now.getMonth()) ? now.getDate().toString().padStart(2,'0') : '01';
        document.getElementById('fDate').value = `${y}-${m}-${d}`;
        setType('exp'); tempCat=''; tempLink=''; renderLinkChips();
    }
    function setType(t) {
        document.getElementById('fType').value = t;
        document.getElementById('seg-exp').className = `tab-btn ${t=='exp'?'active':''}`;
        document.getElementById('seg-inc').className = `tab-btn ${t=='inc'?'active':''}`;
        document.getElementById('linkSection').style.display = t=='exp'?'block':'none';
        renderCatChips(t);
    }
    function renderCatChips(type) {
        const c = document.getElementById('catChips'); c.innerHTML='';
        (data.cats[type]||[]).forEach(cat => {
            const el = document.createElement('div'); el.className=`chip ${tempCat==cat?'active':''}`; el.innerText=cat;
            el.onclick=()=>{ tempCat=cat; document.getElementById('fCat').value=cat; renderCatChips(type); renderConChips(cat); };
            c.appendChild(el);
        });
        const add = document.createElement('div'); add.className='chip'; add.innerHTML='<i class="fas fa-plus"></i>';
        add.onclick=()=>{ const n=prompt('Nueva:'); if(n){ if(!data.cats[type])data.cats[type]=[]; data.cats[type].push(n); data.concepts[n]=[]; saveData(); renderCatChips(type); }};
        c.appendChild(add);
        if(tempCat && (data.cats[type]||[]).includes(tempCat)) renderConChips(tempCat); else document.getElementById('conChips').innerHTML='';
    }
    function renderConChips(cat) {
        const c = document.getElementById('conChips'); c.innerHTML='';
        (data.concepts[cat]||[]).forEach(con => {
            const el=document.createElement('div'); el.className=`chip ${document.getElementById('fConcept').value==con?'active':''}`; el.innerText=con;
            el.onclick=()=>{ document.getElementById('fConcept').value=con; document.getElementById('fCustomDesc').style.display='none'; renderConChips(cat); };
            c.appendChild(el);
        });
        const add=document.createElement('div'); add.className='chip'; add.innerText='...';
        add.onclick=()=>{ document.getElementById('fConcept').value='new'; document.getElementById('fCustomDesc').style.display='block'; document.getElementById('fCustomDesc').focus(); renderConChips(cat); };
        c.appendChild(add);
    }
    function renderLinkChips() {
        const c=document.getElementById('linkChips'); c.innerHTML='';
        const def=document.createElement('div'); def.className=`chip ${!tempLink?'active':''}`; def.innerText='Ninguno';
        def.onclick=()=>{tempLink=''; document.getElementById('fLink').value=''; renderLinkChips();}; c.appendChild(def);
        currentTxs.filter(t=>t.type=='inc').forEach(i=>{
            const el=document.createElement('div'); el.className=`chip ${tempLink==i.id?'active':''}`; el.innerText=i.desc;
            el.onclick=()=>{tempLink=i.id; document.getElementById('fLink').value=i.id; renderLinkChips();}; c.appendChild(el);
        });
    }

    document.getElementById('txForm').onsubmit = (e) => {
        e.preventDefault();
        let cat = document.getElementById('fCat').value; if(!cat) return alert('Categoría?');
        let desc = document.getElementById('fConcept').value;
        if(desc=='new'||!desc) { desc=document.getElementById('fCustomDesc').value; if(desc && !data.concepts[cat].includes(desc)) data.concepts[cat].push(desc); }
        const origAmt = parseFloat(document.getElementById('fAmount').value);
        const curr = document.getElementById('fCurr').value;
        const rates = { ARS: parseFloat(document.getElementById('rateArs').value), COP: parseFloat(document.getElementById('rateCop').value) };
        let amount = origAmt;
        if(curr === 'USD') amount = origAmt * rates.ARS;
        if(curr === 'COP') amount = (origAmt / rates.COP) * rates.ARS;
        const tx = {
            id: editId || Date.now(), date: document.getElementById('fDate').value,
            amount: amount, origAmt: origAmt, curr: curr,
            type: document.getElementById('fType').value, cat: cat, desc: desc,
            exec: document.getElementById('fExec').checked, linkId: document.getElementById('fLink').value || null
        };
        if(editId) { const i=data.txs.findIndex(x=>x.id==editId); if(i>-1) data.txs[i]=tx; } else data.txs.push(tx);
        saveData(); closeSheet();
    };

    function edit(id) {
        editId=id; const t=data.txs.find(x=>x.id==id); if(!t)return;
        document.getElementById('fAmount').value=t.origAmt||t.amount; document.getElementById('fCurr').value=t.curr||'ARS';
        document.getElementById('fDate').value=t.date; document.getElementById('fExec').checked=t.exec;
        document.getElementById('btnDel').style.display='block';
        setType(t.type); tempCat=t.cat; document.getElementById('fCat').value=t.cat; renderCatChips(t.type);
        document.getElementById('fConcept').value=t.desc; renderConChips(t.cat);
        if(!data.concepts[t.cat]?.includes(t.desc)){ document.getElementById('fConcept').value='new'; document.getElementById('fCustomDesc').style.display='block'; document.getElementById('fCustomDesc').value=t.desc; }
        tempLink=t.linkId||''; document.getElementById('fLink').value=tempLink; renderLinkChips();
        openSheet();
    }
    function delTx(){ if(confirm('Eliminar?')){ data.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeSheet(); }}
    
    function cloneTx(id) {
        const t = data.txs.find(x => x.id == id);
        if(!t) return;
        if(!confirm("¿Clonar " + t.desc + "?")) return;
        
        const currentY = currentDate.getFullYear();
        const currentM = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        const newDate = `${currentY}-${currentM}-${t.date.split('-')[2]}`;
        
        const newTx = {...t, id: Date.now(), date: newDate, exec: false};
        data.txs.push(newTx);
        saveData();
    }

    function openCloneModal() {
        const sel = document.getElementById('selCloneSrc'); sel.innerHTML = '';
        const months = new Set();
        data.txs.forEach(t => { if(!t.deletedAt) months.add(t.date.slice(0, 7)); });
        Array.from(months).sort().reverse().forEach(m => {
            const opt = document.createElement('option'); opt.value = m; opt.innerText = m;
            sel.appendChild(opt);
        });
        document.getElementById('modalClone').classList.add('open');
    }

    function doCloneMonth() {
        const srcMonth = document.getElementById('selCloneSrc').value;
        if(!srcMonth) return;
        
        const srcTxs = data.txs.filter(t => !t.deletedAt && t.date.startsWith(srcMonth));
        if(srcTxs.length === 0) return alert('Mes vacío');
        
        const targetY = currentDate.getFullYear();
        const targetM = (currentDate.getMonth() + 1).toString().padStart(2,'0');

        const mapIds = {};
        const newTxs = [];

        srcTxs.filter(t => t.type === 'inc').forEach(t => {
            const newId = Date.now() + Math.random();
            mapIds[t.id] = newId;
            newTxs.push({...t, id: newId, date: `${targetY}-${targetM}-01`, exec: false});
        });

        srcTxs.filter(t => t.type === 'exp').forEach(t => {
            newTxs.push({
                ...t, 
                id: Date.now() + Math.random(), 
                date: `${targetY}-${targetM}-01`, 
                exec: false,
                linkId: t.linkId ? mapIds[t.linkId] : null
            });
        });

        data.txs.push(...newTxs);
        saveData();
        document.getElementById('modalClone').classList.remove('open');
        alert('Clonado exitoso');
    }

    function clearMonth(){ if(confirm('¿Borrar TODO este mes?')) { const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; data.txs.forEach(t=>{ if(parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m) t.deletedAt=Date.now(); }); saveData(); }}

    function nav(v) {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(`view-${v}`).classList.add('active');
        document.getElementById(`nav-${v}`).classList.add('active');
        if(v=='stats') renderStats(); if(v=='settings') renderSettings();
    }
    function setSubTab(t) {
        document.getElementById('sec-txs').style.display=t=='txs'?'flex':'none';
        document.getElementById('sec-alloc').style.display=t=='alloc'?'block':'none';
        document.getElementById('tab-txs').className=`tab-btn ${t=='txs'?'active':''}`;
        document.getElementById('tab-alloc').className=`tab-btn ${t=='alloc'?'active':''}`;
        
        if(t=='txs') {
             document.getElementById('searchContainerExp').classList.remove('hidden');
             document.getElementById('searchContainerExp').style.display = 'flex';
        } else {
             document.getElementById('searchContainerExp').style.display = 'none';
        }
    }

    async function forceSync() {
        document.getElementById('loader').style.display='flex';
        try { const r = await fetch(API_URL); const d = await r.json(); if(d) { data.txs=d.txs||[]; data.cats=d.cats||data.cats; data.concepts=d.concepts||data.concepts; data.recurrentes=d.recurrentes||[]; data.monthlyRates=d.monthlyRates||{}; saveData(); document.getElementById('syncDot').style.background='#10B981'; } } catch(e){ console.error(e); }
        document.getElementById('loader').style.display='none';
    }
    async function saveData() {
        document.getElementById('syncDot').style.background='#F59E0B'; localStorage.setItem('finance_mobile_data_v5', JSON.stringify(data)); loadData();
        try { await fetch(API_URL, {method:'POST', body:JSON.stringify(data)}); document.getElementById('syncDot').style.background='#10B981'; } catch(e){ document.getElementById('syncDot').style.background='#EF4444'; }
    }
</script>
</body>
</html>
